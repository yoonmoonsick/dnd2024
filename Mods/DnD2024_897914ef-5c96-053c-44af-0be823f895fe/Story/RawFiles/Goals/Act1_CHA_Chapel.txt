Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION VoiceBark
DB_OneShot_VoiceBarkTrigger(CHA_FL1_VB_Sanctum_570955c3-0401-47ed-951e-c08fa96d8d4e,CHA_FL1_VB_Sanctum_76c96afd-add9-ad97-f8ae-ce570fefe4eb);
DB_OneShot_VoiceBarkTrigger(CHA_FL0_VB_LowerFloor_1c231d53-4e98-4cf5-9e34-5801ca49e1cd,CHA_FL0_VB_LowerFloor_12cef6a8-b2ea-9ee5-b89a-605f3c28dc2b);
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_CHA_FL0_VB_SideChamber_a85c4479-12ec-48a9-9e66-e355d9e628e0, (VOICEBARKRESOURCE)CHA_FL0_VB_SideChamber_99cf32ba-8377-4bc7-32e5-8cce52550559);
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_CHA_FL0_VB_Artefact_21a4b08e-5650-45c1-b29a-1df67cba24bd, (VOICEBARKRESOURCE)CHA_FL0_VB_Artefact_402a0533-0151-bc1f-48f0-4dcadab8cbf3);

PROC_TriggerRegisterForPlayers((TRIGGER)S_CHA_FL0_VB_SkeletonArea_14756f69-b2bd-4608-865a-39cf5999fd05);
//END_REGION

//REGION Bronze plaque
//DB_CHA_BronzePlaque((ITEM)_Plaque,(DIALOGRESSOURCE)_AD);
DB_CHA_BronzePlaque((ITEM)S_CHA_Plaque_000_31209dca-d0e2-43b1-8be7-6ea0b3041819, (DIALOGRESOURCE)CHA_BronzePlaque_AD_OutsideStatue_822d5f57-7281-0361-8116-7500ff1083c7);
DB_CHA_BronzePlaque(S_CHA_Plaque_001_92a01bd1-b2f3-4245-b78a-05df1f78695f, CHA_BronzePlaque_AD_SanctumStatue_7e66380f-f6a0-2fda-8b59-904c02c877a1);
DB_CHA_BronzePlaque(S_CHA_Plaque_002_afc4f249-059a-42ef-bb6f-1c40a0449d0a, CHA_BronzePlaque_AD_FL1Mural_c73221e9-e886-a839-ef5a-2f4f7cbc321a);
DB_CHA_BronzePlaque(S_CHA_Plaque_003_33c35bc5-e966-44fb-998e-4ee21477ce13, CHA_BronzePlaque_AD_TrappedTomb_d66948af-2f38-b7b2-a00a-a1dd3d681e39);
DB_CHA_BronzePlaque(S_CHA_Plaque_004_9579c962-a329-4d8d-98e6-697f71e9982f, CHA_BronzePlaque_AD_SqueletonRoom_1593d572-6d5c-57bb-1a51-f7af2a3a025f);
DB_CHA_BronzePlaque(S_CHA_Plaque_005_28b32f99-bbd6-4154-b906-ca593c7f23b4, CHA_BronzePlaque_PAD_RichSarcophagus_c7c37854-caf2-e842-49b7-16c546907d0d);
//END_REGION

//REGION Journal
PROC_TriggerRegisterForPlayers(S_CHA_ChapelBox_81eaa47c-0516-42a4-9eaa-e1a9b6983893);

PROC_TriggerRegisterForPlayers((TRIGGER)S_CHA_FL1_HatchEntrance_3f74d3eb-53e1-4b4a-bef1-dcc4d92f480a);
PROC_TriggerRegisterForPlayers((TRIGGER)S_CHA_FL0_BeachEntrance_48300ab9-4e48-4a44-80a0-bfccd0539ba8);
PROC_TriggerRegisterForPlayers((TRIGGER)S_CHA_FL0_WeirdDoorEntrance_68948232-bb84-4796-b013-64afd0d6c85a);

DB_QuestDef_State((FLAG)CHA_Crypt_Event_ReadJergalPlaque_a33470ad-0e78-41c8-a5ec-71467eeaf363, "CHA_Chapel", "ReadSarcophagusPlaque");
DB_QuestDef_State((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3, "CHA_Chapel", "LeftRegion");
//END_REGION
//OUTSIDE
//REGION Outside bandits
DB_SceneAllowAllDisturbances("CHA_OutsideBandit");

DB_CHA_OutsideBanditsDialogues((DIALOGRESOURCE)CHA_Outside_BanditInteraction_255e9f17-5a10-d273-f504-5d0d414b84e2);
DB_CHA_OutsideBanditsDialogues((DIALOGRESOURCE)CHA_Outside_BanditBackInteraction_Spotted_d8ea2e7b-10d2-203c-2a8e-ec195a9893da);
DB_CHA_OutsideBanditsDialogues((DIALOGRESOURCE)CHA_Outside_BanditWestInteraction_89b6d80a-0882-1c67-ba7f-5e68daf2165b);

DB_DialogBlockAttackButton((DIALOGRESOURCE)CHA_Outside_EntranceDoor_c6ab2cbd-4d56-e595-5a6e-cdef7c1719e5);

PROC_TriggerRegisterForPlayers(S_CHA_OUTSIDE_HighSideJournalUnlock_451681ad-6389-4a64-b550-c656866d9a19);
PROC_TriggerRegisterForPlayers(S_CHA_OUTSIDE_BanditConversationTrigger_db3aded6-8dc3-4072-958b-cc83d012a9e7);
PROC_TriggerRegisterForPlayers(S_CHA_OUTSIDE_BanditConversationTriggerFromInside_e0640487-aab3-4e91-b356-a98ab73d10fe);
PROC_TriggerRegisterForPlayers(S_CHA_OUTSIDE_BanditConversationTriggerFromWest_609e42e9-ca90-4a56-aee6-f645084139c9);
SetHasDialog(S_CHA_Exterior_Bandit_Ranger_01_fa1a1fbd-2152-40e4-b53d-29e95d54279e,1);
DB_SceneTriggerManager("CHA_OutsideBandit",(TRIGGER)S_CHA_OUTSIDE_Bandit_SpotterArea_66fff0ca-cbdd-455b-be73-af42d32dcb5e);

//DB_CHA_OutsideBandits((CHARACTER)_Bandit,(STRING)_SpotterID);
DB_CHA_OutsideBandits((CHARACTER)S_CHA_Exterior_Bandit_Melee_01_538e38b9-e3a4-452a-8369-60eb1fe8c40d);
DB_CHA_OutsideBandits((CHARACTER)S_CHA_Exterior_Bandit_Caster_01_0f4300f6-0e1e-4d6c-a582-5da588d64ea7);
DB_CHA_OutsideBandits((CHARACTER)S_CHA_Exterior_Bandit_Melee_02_b5c913f9-f081-45bd-8e95-e34d0735b645);
DB_CHA_OutsideBandits((CHARACTER)S_CHA_Exterior_Bandit_Ranger_01_fa1a1fbd-2152-40e4-b53d-29e95d54279e);

SetFlag(CHA_Outside_State_BanditIdleScene_4242a524-7cd9-4e62-9ddc-14324923e3a7, S_CHA_Exterior_Bandit_Melee_01_538e38b9-e3a4-452a-8369-60eb1fe8c40d);
SetFlag(CHA_Outside_State_BanditIdleScene_4242a524-7cd9-4e62-9ddc-14324923e3a7, S_CHA_Exterior_Bandit_Melee_02_b5c913f9-f081-45bd-8e95-e34d0735b645);

DB_GLO_CharacterCorpseDialog((CHARACTER)S_CHA_Exterior_Bandit_Melee_01_538e38b9-e3a4-452a-8369-60eb1fe8c40d, (DIALOGRESOURCE)CHA_Outside_Bandit_Melee_01_Dead_6f4678c9-bd29-da25-7b48-6de54711f85c);

DB_CHA_OutsideBandits_SpeakerSlot((CHARACTER)S_CHA_Exterior_Bandit_Caster_01_0f4300f6-0e1e-4d6c-a582-5da588d64ea7);
DB_CHA_OutsideBandits_SpeakerSlot((CHARACTER)S_CHA_Exterior_Bandit_Ranger_01_fa1a1fbd-2152-40e4-b53d-29e95d54279e);
//END_REGION

//BOULDER
//REGION Boulder Puzzle
DB_CHA_BoulderAttacker((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

SetOnStage(S_CHA_FL1_Fissure_Boulder_000_a27427a2-cc8f-4f82-b611-ea11457d2ba9, 0);
SetOnStage(S_CHA_FL1_FissureFloor_5c6af29d-dce4-43c8-8192-ad4493a3297a, 0);

TriggerRegisterForItems(S_CHA_Outside_HoleTrigger_de003198-dc27-4180-a0c6-3cb299367fa1);
TriggerRegisterForItems(S_CHA_OUTSIDE_Fissure_DamageTrigger_bc19692f-7418-4556-adad-d132d0b56fdd);
TriggerRegisterForItems(S_CHA_FL1_Fissure_DamageTrigger_df060f8d-7c3f-49af-874b-eb869c1f0056);

PROC_TriggerRegisterForParty(S_CHA_FL1_Fissure_BoulderPartyTrigger_bc6920e7-9d41-4a71-b2bb-18584e71400c);

DB_CHA_Chapel_ValidBoulderDamageTypes("Slashing");
DB_CHA_Chapel_ValidBoulderDamageTypes("Piercing");
DB_CHA_Chapel_ValidBoulderDamageTypes("Bludgeoning");
DB_CHA_Chapel_ValidBoulderDamageTypes("Acid");
DB_CHA_Chapel_ValidBoulderDamageTypes("Thunder");
DB_CHA_Chapel_ValidBoulderDamageTypes("Fire");
DB_CHA_Chapel_ValidBoulderDamageTypes("Lightning");
DB_CHA_Chapel_ValidBoulderDamageTypes("Cold");
DB_CHA_Chapel_ValidBoulderDamageTypes("Force");
//END_REGION

//LIVING QUARTER
//REGION Inside Bandits
//DB_CHA_InsideBandits((CHARACTER) _Bandit, (STRING) _SpotterID, (DIALOGRESSOURCE) _SpotterAD);
DB_CHA_InsideBandits((CHARACTER) S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a,(DIALOGRESOURCE)CHA_Crypt_AD_BanditGuardSpotting_10a14868-5fa5-871a-7870-b0d213c4a862);
DB_CHA_InsideBandits(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,CHA_Crypt_AD_BanditLockpickerSpotting_9015d849-8bba-d257-2a50-70f8fcc98e1f);
DB_CHA_InsideBandits(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7,CHA_Crypt_AD_BanditSanctumSpotting_4f3d8e39-48ee-c183-8b38-39e27909cdba);

DB_CHA_SanctumBandits((CHARACTER)S_CHA_FL1_BanditSanctum_01_fd5f646a-d5f6-4f19-904f-61dfc7e14d7e);
DB_CHA_SanctumBandits((CHARACTER)S_CHA_FL1_BanditSanctum_02_5d2f2ff7-d1c0-4f95-b12a-b17b60182cfc);
DB_CHA_SanctumBandits((CHARACTER)S_CHA_FL1_BanditSanctum_03_81e99fb9-2a52-4a26-910d-a637c379f15b);

DB_CHA_UpperCryptTrap(S_PUZ_Trap_Mine_ChapelEntrance_454e4ce5-80ba-4c71-a536-195cecfaf4e4);

PROC_TriggerRegisterForPlayers(S_CHA_BanditLockpickerSurpriseBox_09672d3d-e502-422c-a5ab-5901a2de87d4);
PROC_TriggerRegisterForPlayers(S_CHA_BanditLockpickerFromBelowBox_4c11f88e-ec3d-4a40-95f5-f634e56e7b83);
PROC_TriggerRegisterForPlayers(S_CHA_BanditsOpenDoorBanter_609f6042-554a-4490-9484-5089b4ed7eaa);

PROC_TriggerRegisterForParty(S_CHA_Crypt_SUB_001_f8bc812e-1cb3-46bd-942a-9f572f66ef16);

TriggerRegisterForCharacter(S_CHA_FL0_AndornEntranceDoorDialog_9f560f72-9e1a-4e01-b660-c3da71638d9e, S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a);
//END_REGION

//REGION Metal Door
DB_CHA_MetalDoorLever((ITEM)S_CHA_FL1_MetalLever_41140570-efdb-44d0-8943-8ea29584dd42);
DB_CHA_MetalDoorLever(S_CHA_FL1_MetalLever_2_7c41cd46-c233-438c-ad5b-03d79cac9a44);
//END_REGION

//CRYPT
//REGION Poison trap
DB_CHA_Crypt_GasPit(S_CHA_PUZ_Gaspit_A_001_8badeb96-e3bf-4b5f-8360-91967ced271e);
DB_CHA_Crypt_GasPit(S_CHA_PUZ_Gaspit_A_002_97d7987f-aa91-46d9-b74d-03fba30bab75);
DB_CHA_Crypt_GasPit(S_CHA_PUZ_Gaspit_A_003_ad7cc8b8-9c97-4937-9622-beffb1e52f9b);
DB_CHA_Crypt_GasPit(S_CHA_PUZ_Gaspit_A_004_a49c522a-312f-4453-8abd-3a92460bb4d5);
DB_CHA_Crypt_GasPit(S_CHA_PUZ_Gaspit_A_005_e09ceac1-f081-4c25-84cf-2f5dba7911b6);
DB_CHA_Crypt_GasPit(S_CHA_PUZ_Gaspit_A_006_fed286e7-4164-49e6-8e6c-e3c2d9321953);
//END_REGION

//REGION Secret tomb lights
//DB_CHA_SecretAlcoveLight((ITEM)_Light);
DB_CHA_SecretAlcoveLight((ITEM)S_CHA_FL0_Candles_F_004_59380f30-d38b-4d02-9527-c93717ab30c2);
DB_CHA_SecretAlcoveLight((ITEM)S_CHA_FL0_Candles_E_004_81a8b173-76ac-410c-9947-a61a06191725);
DB_CHA_SecretAlcoveLight((ITEM)S_CHA_FL0_Candles_E_000_a35bef52-af23-447e-82d2-277fd1123559);

//DB_CHA_SkeletonRoomLight((ITEM)_Light);
DB_CHA_SkeletonRoomLight((ITEM)S_CHA_FL0_SkeletonRoomCandlestick_6_a5f7662e-a98e-4135-ab0b-1fe2b08952ab);
DB_CHA_SkeletonRoomLight((ITEM)S_CHA_FL0_SkeletonRoomCandlestick_2_69b92dbc-3368-476e-9fb1-96e6825ef921);
DB_CHA_SkeletonRoomLight((ITEM)S_CHA_FL0_SkeletonRoomCandlestick_3_85df8d88-2e7b-4872-be81-4a92d61b2c36);
DB_CHA_SkeletonRoomLight((ITEM)S_CHA_FL0_SkeletonRoomCandlestick_4_b9f1e7e2-3635-4d11-bfb3-2aedddc72396);
DB_CHA_SkeletonRoomLight((ITEM)S_CHA_FL0_SkeletonRoomCandlestick_5_4bf839d7-3af3-415e-a3ed-31aeb9919451);


PROC_TriggerRegisterForPlayers(S_CHA_FL0_LightAlcove_f0524a5a-e38d-484b-9820-cfe37725ff26);
//END_REGION

//REGION Undead Guardian Ambush
DB_DropMutingStatussesDialog(CHA_Crypt_SkeletonRisingCinematic_a966e44d-6d7c-48d1-5d3b-6469ae00720b);

SetOnStage(S_CHA_Door_SlidingWall_DungeonAbbey_A_001_cb0c8869-6e84-4736-9810-ef997b4dad54,1);

PROC_TriggerRegisterForPlayers(S_CHA_FL0_RisingCinematicInclusion_f929b9ee-3d22-443e-91ab-8385255dbe8d);
DB_AddCharactersInTriggerToDialog(CHA_Crypt_SkeletonRisingCinematic_a966e44d-6d7c-48d1-5d3b-6469ae00720b,S_CHA_FL0_RisingCinematicInclusion_f929b9ee-3d22-443e-91ab-8385255dbe8d, 1, 0);

//DB_CHA_UndeadGuardian((CHARACTER) _Skeleton);
DB_CHA_UndeadGuardian((CHARACTER)S_CHA_FL0_DeadSkeleton_Melee_01_ebf854f1-7971-4f81-a2b7-e4b79b550b85);
DB_CHA_UndeadGuardian((CHARACTER)S_CHA_FL0_DeadSkeleton_Melee_02_7af3fa6c-7f7a-4920-acaf-f091e7c62373);
DB_CHA_UndeadGuardian((CHARACTER)S_CHA_FL0_DeadSkeleton_Ranger_01_1535feb9-7ff9-4132-be09-191ba3f8c2e1);
DB_CHA_UndeadGuardian((CHARACTER)S_CHA_FL0_DeadSkeleton_Ranger_02_462f0982-35c4-4a34-a3bf-399f37e686ee);
DB_CHA_UndeadGuardian((CHARACTER)S_CHA_FL0_DeadSkeleton_Ranger_03_cb4c2c8f-b6db-4c53-b7e3-395aef311a39);

PROC_TriggerRegisterForPlayers(S_CHA_ExitGuardianFight_db2a38d6-bf88-4b28-9ecc-2901260bc8c2);
//END_REGION

//REGION
DB_CHA_ShadowheartCommentADs((DIALOGRESOURCE)CHA_BronzePlaque_AD_FL1Mural_c73221e9-e886-a839-ef5a-2f4f7cbc321a);
DB_CHA_ShadowheartCommentADs(CHA_BronzePlaque_AD_OutsideStatue_822d5f57-7281-0361-8116-7500ff1083c7);
DB_CHA_ShadowheartCommentADs(CHA_BronzePlaque_AD_SanctumStatue_7e66380f-f6a0-2fda-8b59-904c02c877a1);
DB_CHA_ShadowheartCommentADs(CHA_BronzePlaque_AD_SqueletonRoom_1593d572-6d5c-57bb-1a51-f7af2a3a025f);
DB_CHA_ShadowheartCommentADs(CHA_BronzePlaque_AD_TrappedTomb_d66948af-2f38-b7b2-a00a-a1dd3d681e39);
DB_CHA_ShadowheartCommentADs(CHA_BronzePlaque_PAD_RichSarcophagus_c7c37854-caf2-e842-49b7-16c546907d0d);

DB_CHA_ShadowheartCommentVBs((VOICEBARKRESOURCE)CHA_FL1_VB_Sanctum_76c96afd-add9-ad97-f8ae-ce570fefe4eb);

DB_CHA_ShadowheartCommentCounter(0);
DB_CHA_ShadowheartMaxComments(3);

SetFlag((FLAG)CHA_Shadowheart_SeluneComment_fdedef69-720c-5b93-06c6-d7547d4cfbd3, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION Inside bandits killcount
DB_GLO_DefeatCounter((CHARACTER)S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a, "CHA_ChapelInsideBandits");
DB_GLO_DefeatCounter((CHARACTER)S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, "CHA_ChapelInsideBandits");
DB_GLO_DefeatCounter((CHARACTER)S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7, "CHA_ChapelInsideBandits");

DB_GLO_DefeatCounter((CHARACTER)S_CHA_FL1_BanditSanctum_01_fd5f646a-d5f6-4f19-904f-61dfc7e14d7e, "CHA_ChapelInsideBandits");
DB_GLO_DefeatCounter((CHARACTER)S_CHA_FL1_BanditSanctum_02_5d2f2ff7-d1c0-4f95-b12a-b17b60182cfc, "CHA_ChapelInsideBandits");
DB_GLO_DefeatCounter((CHARACTER)S_CHA_FL1_BanditSanctum_03_81e99fb9-2a52-4a26-910d-a637c379f15b, "CHA_ChapelInsideBandits");

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("CHA_ChapelInsideBandits",(FLAG)CHA_FL1_State_BanditsDead_d92afbc6-b7ac-431b-b440-1c5fa30ea688);
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("CHA_OutsideBandits",(FLAG)CHA_Outside_Event_BanditsPermaDefeated_c61f7816-570e-4012-a10a-3a6d63c77608);
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("CHA_UndeadGuardians",(FLAG)CHA_FL0_State_AllSkeletonDead_a2c88791-9ff6-4bd8-8945-78e819389a3e);
//END_REGION

//REGION Ladder
SetForceUpdate(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10, 1);
SetCanInteract(S_CHA_FL0_LadderToOutside_a7c7ffa0-a495-42c5-bcd1-fc1767d2affd, 0);
//END_REGION

//REGION Crypt soul coins
DB_CHA_Crypt_Coins((ITEM)S_CHA_Crypt_SoulCoin_000_8cace579-73f6-462e-92a1-bb0d1cdec8c9);
DB_CHA_Crypt_Coins((ITEM)S_CHA_Crypt_SoulCoin_001_c1d027cd-84d5-4f41-9473-0ec69f3ba674);
DB_CHA_Crypt_Coins((ITEM)S_CHA_Crypt_SoulCoin_002_c479965d-2b64-4de1-acf4-808b7ac0a69f);
//END_REGION

//REGION Candles puzzle
DB_CHA_CandlesPuzzle(S_CHA_FL1_LeftCandle_99e2277e-c192-4387-a657-a0a2ac291171);
DB_CHA_CandlesPuzzle(S_CHA_FL1_RightCandle_8f687885-24c4-43cf-ab36-e83f5163c91c);
//END_REGION

//REGION Jergal
PROC_GLO_Jergal_SetDialog((DIALOGRESOURCE)CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5);
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5);
DB_DialogBlockAttackButton((DIALOGRESOURCE)CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5);

PROC_TriggerRegisterForPlayers(S_CHA_Crypt_JergalRiseTrigger_a4efa36c-88b2-4378-bc30-9faa3c2b9510);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5, (TRIGGER)S_CHA_Crypt_JergalRiseTrigger_a4efa36c-88b2-4378-bc30-9faa3c2b9510, 1, 0);

DB_KnowledgeCheckTrigger_AD("CHA_Crypt_JergalReligionCheck", (TRIGGER)S_CHA_Crypt_JergalReligionCheck_4f24d7ac-b650-45cf-b3b4-1557c682e400, "Religion", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)CHA_Crypt_PAD_JergalStatueReaction_9f69efc3-99c7-a8c0-1f71-b83de2259ae1, (FLAG)CHA_Crypt_Event_JergalReligionCheckSuccess_b12671bc-224f-4c5b-96f0-ccd35d825ad4);
//END_REGION

//REGION Autosave triggers
DB_AutosaveGroup((TRIGGER)S_CHA_Crypt_Autosave_000_f8dbe045-8ecf-4ee5-a133-f2ba76e4071b, "CHA_Crypt");
DB_AutosaveGroup((TRIGGER)S_CHA_Crypt_Autosave_001_73f43398-ff93-42a8-a8dc-35f6d46129fc, "CHA_Crypt");
DB_AutosaveGroup((TRIGGER)S_CHA_Crypt_Autosave_002_82d1eae5-4aa6-4fe1-b786-87f983530d72, "CHA_Crypt");

DB_AutosaveGroup((TRIGGER)S_CHA_LivingQuarters_Autosave_000_f7797711-8eeb-48c5-81d4-661d614eef1d, "CHA_LivingQuarters");
DB_AutosaveGroup((TRIGGER)S_CHA_LivingQuarters_Autosave_001_98a6edd3-0bd9-4846-a643-9bcfa5398340, "CHA_LivingQuarters");
DB_AutosaveGroup((TRIGGER)S_CHA_LivingQuarters_Autosave_002_6c44c8b2-fc00-4563-a866-63fbd86cf714, "CHA_LivingQuarters");

//END_REGION Autosave triggers

//REGION Hanging coal baskets
DB_GLO_FireBowls((ITEM)S_CHA_Hanging_Bowls_B_000_1d6684de-cfe4-493a-a3cd-01a7351171e0,S_CHA_Hanging_Bowls_Hinge_A_000_9e9f9ed1-860c-4595-b5f3-63956f9427d8);
DB_GLO_FireBowls(S_CHA_Hanging_Bowls_B_001_f9c4402e-7d22-4fc4-9307-4549b10aba71,S_CHA_Hanging_Bowls_Hinge_A_001_de00796e-6aa2-443c-af31-313e3230e8e1);
DB_GLO_FireBowls(S_CHA_Hanging_Bowls_B_002_105fc881-5110-45d6-900d-0b6181f9f555,S_CHA_Hanging_Bowls_Hinge_A_002_142ce249-89e6-4aeb-a245-f75e21eca611);
DB_GLO_FireBowls(S_CHA_Hanging_Bowls_B_003_e8f95cb5-022c-4f56-8b15-18d3550498f8,S_CHA_Hanging_Bowls_Hinge_A_003_f3ef0852-46f2-42f1-a91d-e9d6472cd349);
DB_GLO_FireBowls(S_CHA_Hanging_Bowls_B_004_a6976197-6fda-49bf-8fd5-9362adf5c502,S_CHA_Hanging_Bowls_Hinge_A_004_0214a060-af97-420c-bf63-7b35bb0e20a2);
DB_GLO_FireBowls(S_CHA_Hanging_Bowls_B_005_8f30915b-4b4e-4adf-a2a0-3424fe4ecaa2,S_CHA_Hanging_Bowls_Hinge_A_005_1d3b6ba1-74cf-444e-9320-6815489095d7);
//END_REGION
KBSECTION
//REGION Cheat
IF
TextEvent("CHA_CryptOpen")
THEN
Unlock(S_CHA_OUTSIDE_Crypt_Door_d06d5638-c69a-4fcc-b996-c305acbb7ebf);
Unlock(S_CHA_FL0_Entrance_Door_TEMP_73e52fe0-74d3-4b3a-b331-acf60066b1d2);

IF
TextEvent("CHA_BoulderFall")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("debug_CHA_BoulderFall")
THEN
PROC_CHA_DestroyPillar(_Player);

IF
TextEvent("CHA_Desecrate")
AND
GetClosestPlayer(S_CHA_FL0_ButtonToSecretDoor_51cdb6e6-e998-46ad-af8c-e6a531654137, _Player, _dist)
THEN
PROC_CHA_Desecration(_Player);

IF
TextEvent("CHA_Resurrect")
AND
DB_CHA_UndeadGuardian(_Skel)
THEN
Resurrect(_Skel, STAT_KO_01_End_37fe9557-0310-4273-9e28-03c1613e4101, 1);

IF
TextEvent("CHA_SteeringBug")
THEN
CharacterMoveTo(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7, S_CHA_BanditSanctumCrashPosition_1b32e3b3-4207-47ac-b410-fcddf4cf3837, "Run","CHA_SteeringBug_Step1");
LookFromTrigger(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7, S_CHA_BanditSanctumCrashPosition_1b32e3b3-4207-47ac-b410-fcddf4cf3837, 0);

IF
TextEvent("CHA_DeactivateTrap")
THEN
PROC_CHA_CrypTrap_Deactivate();

IF
TextEvent("CHA_UnlockJergal")
THEN
SetFlag(CHA_FL0_State_AllSkeletonDead_a2c88791-9ff6-4bd8-8945-78e819389a3e, NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("CHA_RevealJergalButton")
THEN
SetEntityEvent(S_CHA_FL0_ButtonToSecretDoor_51cdb6e6-e998-46ad-af8c-e6a531654137, "StoryReveal");
//END_REGION

//REGION Unlocking door from both sides
//Shadowheart meeting door
IF
Unlocked(CHA_FL0_Entrance_Door_TEMP_73e52fe0-74d3-4b3a-b331-acf60066b1d2, _Player, _Key)
THEN
Unlock(S_CHA_OUTSIDE_Crypt_Door_d06d5638-c69a-4fcc-b996-c305acbb7ebf);

IF
Unlocked(S_CHA_OUTSIDE_Crypt_Door_d06d5638-c69a-4fcc-b996-c305acbb7ebf, _Player, _Key)
THEN
Unlock(CHA_FL0_Entrance_Door_TEMP_73e52fe0-74d3-4b3a-b331-acf60066b1d2);


//Outside bandit door
IF
Unlocked(S_CHA_OUTSIDE_Entrance_Door_000_2647dac6-234b-4e6f-8321-f88e95359fc4, _Player, _Key)
THEN
Unlock(CHA_FL1_Entrance_Door_4aa7744b-0267-4fae-ac4c-987c77d8977b);

IF
Unlocked(CHA_FL1_Entrance_Door_4aa7744b-0267-4fae-ac4c-987c77d8977b, _Player, _Key)
THEN
Unlock(S_CHA_OUTSIDE_Entrance_Door_000_2647dac6-234b-4e6f-8321-f88e95359fc4);

//END_REGION

//REGION BronzePlaque
IF
UseStarted(_Player, _Plaque)
AND
DB_CHA_BronzePlaque(_Plaque, _AD)
AND
DB_Players(_Player)
THEN
PROC_TryStartAD(_AD, _Player);
//END_REGION

//REGION Journal
// Objective CHA_Chapel_FindWay
// Read book
IF
GameBookInterfaceClosed(S_DEN_DruidChapelBook_99c09b91-dd90-4703-aa92-eb9d6c22963b, _Player)
AND
DB_Players(_Player)
AND
QuestIsAccepted(_Player, "CHA_Chapel", 0)
THEN
QuestUpdate(_Player, "CHA_Chapel", "ReadDruidBook");

// Objective CHA_Chapel_Investigate
// First time in the chapel where the bandits are.
IF
EnteredTrigger(_Player, S_CHA_Crypt_SUB_001_f8bc812e-1cb3-46bd-942a-9f572f66ef16)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "CHA_Chapel", "AccessedTemple", 0)
THEN
QuestUpdate(_Player, "CHA_Chapel", "AccessedTemple");

// Objective CHA_Chapel_Explore
IF
EnteredTrigger(_Player, S_CHA_FL1_HatchEntrance_3f74d3eb-53e1-4b4a-bef1-dcc4d92f480a)
THEN
PROC_CHA_Chapel_UnlockExploreObjective(_Player, "HatchEntrance");

IF
EnteredTrigger(_Player, S_CHA_FL0_BeachEntrance_48300ab9-4e48-4a44-80a0-bfccd0539ba8)
THEN
PROC_CHA_Chapel_UnlockExploreObjective(_Player, "BeachEntrance");

IF
EnteredTrigger(_Player, S_CHA_FL0_WeirdDoorEntrance_68948232-bb84-4796-b013-64afd0d6c85a)
THEN
PROC_CHA_Chapel_UnlockExploreObjective(_Player, "WeirdDoorEntrance");

PROC
PROC_CHA_Chapel_UnlockExploreObjective((CHARACTER)_Player, (STRING)_StepID)
THEN
QuestUpdate(_Player, "CHA_Chapel", _StepID);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_CHA_FL1_HatchEntrance_3f74d3eb-53e1-4b4a-bef1-dcc4d92f480a);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_CHA_FL0_BeachEntrance_48300ab9-4e48-4a44-80a0-bfccd0539ba8);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_CHA_FL0_WeirdDoorEntrance_68948232-bb84-4796-b013-64afd0d6c85a);

IF
UseFinished(_Player, S_CHA_Plaque_005_28b32f99-bbd6-4154-b906-ca593c7f23b4, 1)
AND
DB_GlobalFlag((FLAG)GLO_Jergal_HasMet_c8c4ec60-7a6a-4ab6-a6f8-3e6b75df1bc6)
AND
NOT DB_GlobalFlag((FLAG)CHA_Jergal_Event_InteractedWithTomb_703d93aa-823b-4c6f-a677-e5271d97e38d)
THEN
SetFlag(CHA_Crypt_Event_ReadJergalPlaque_a33470ad-0e78-41c8-a5ec-71467eeaf363, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_PlayerInCamp(_Player)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Jergal_HasMet_AtCamp_838852f9-c395-43d0-b90e-20c15cfd8b14)
AND
NOT DB_OnlyOnce("CHA_ConfrontJergal")
THEN
PROC_CHA_Crypt_UpdateJergalAtCamp(_Player);

PROC
PROC_CHA_Crypt_UpdateJergalAtCamp((CHARACTER) _Player)
AND
DB_GlobalFlag((FLAG)CHA_Jergal_HasMet_AtChapel_58201daf-b32c-4fc5-a8d4-74e9eeb9cf2c)
AND
DB_GlobalFlag(GLO_Jergal_State_JergalVisibleAtCamp_617fe345-b808-4e68-b970-14039e21bdcd)
AND
QRY_OnlyOnce("CHA_ConfrontJergal")
THEN
QuestUpdate(_Player, "CHA_Chapel", "ConfrontJergal");

//END_REGION

//REGION Outside bandit spotter behavior
IF
DB_CHA_OutsideBandits(_Char)
THEN
TriggerRegisterForCharacter(S_CHA_OUTSIDE_BanditLootTrigger_46af9de9-e850-4f0e-bdf6-499e5cb555c2, _Char);
DB_SpotPlayers(_Char, "CHA_OutsideBanditSpotter", (FLAG)CHA_OUTSIDE_Event_Bandit_StartSpotting_5afd8fe0-a66b-4dc6-b1f0-aee8cdd9ee10, (FLAG)CHA_OUTSIDE_Event_Bandit_StopSpotting_0cd56731-7d2e-4d10-956e-c5e20d337710);
DB_SpotPlayers_IgnoreCombat(_Char, "CHA_OutsideBanditSpotter");
DB_SpotPlayers_Continuous(_Char, "CHA_OutsideBanditSpotter");
DB_SpotPlayers_SpotTrigger(_Char, "CHA_OutsideBanditSpotter", S_CHA_OUTSIDE_Bandit_SpottingArea_66fff0ca-cbdd-455b-be73-af42d32dcb5e);
DB_SpotPlayers_TargetIgnoreCantTalk(_Char, "CHA_OutsideBanditSpotter");
DB_SpotPlayers_IncludeSummons(_Char, "CHA_OutsideBanditSpotter");
DB_SpotPlayers_IncludeFollowers(_Char, "CHA_OutsideBanditSpotter");
DB_SpotPlayers_IncludeWildshapedPlayers(_Char, "CHA_OutsideBanditSpotter");
DB_GLO_DefeatCounter(_Char, "CHA_OutsideBandits");

// Player comes out of the chapel and bandits see him
// If Taman spots player and the dialog hasn't started yet, set flag for his node.
PROC
PROC_SpotPlayers_Spotted(S_CHA_Exterior_Bandit_Melee_02_b5c913f9-f081-45bd-8e95-e34d0735b645, "CHA_OutsideBanditSpotter", _Player)
AND
NOT DB_OnlyOnce("CHA_DialogWithOutsideBandits")
THEN
SetFlag((FLAG)CHA_OUTSIDE_Event_TamanSpotsPlayer_86c45a49-2a0e-5637-1848-8f9722c29a97, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted(_Bandit, "CHA_OutsideBanditSpotter", _Player)
AND
DB_CHA_OutsideBandits( _Bandit)
AND
DB_InRegion(_Player, S_CHA_OUTSIDE_BanditConversationTriggerFromInside_e0640487-aab3-4e91-b356-a98ab73d10fe)
THEN
PROC_CHA_StartBanditDialog_FromInside((CHARACTER)_Player, (CHARACTER)_Bandit);

PROC
PROC_SpotPlayers_Spotted(S_CHA_Exterior_Bandit_Ranger_01_fa1a1fbd-2152-40e4-b53d-29e95d54279e, "CHA_OutsideBanditSpotter", _Player)
AND
DB_InRegion(_Player, S_CHA_OUTSIDE_BanditConversationTriggerFromWest_609e42e9-ca90-4a56-aee6-f645084139c9)
THEN
PROC_CHA_StartBanditDialog_FromWest(_Player);

// Player arrives to the chapel through the entrance with the statue
PROC
PROC_SpotPlayers_Spotted(_Bandit, "CHA_OutsideBanditSpotter", _Player)
AND
DB_CHA_OutsideBandits(_Bandit)
AND
DB_InRegion(_Player, S_CHA_OUTSIDE_BanditConversationTrigger_db3aded6-8dc3-4072-958b-cc83d012a9e7)
THEN
PROC_CHA_StartBanditDialog((CHARACTER)_Player, _Bandit);

// Bandit spots player and he comes neither from the statue or from inside the chapel: start combat
PROC
PROC_SpotPlayers_Spotted(_Bandit, "CHA_OutsideBanditSpotter", _Player)
AND
DB_CHA_OutsideBandits(_Bandit)
AND
NOT DB_InRegion(_Player, S_CHA_OUTSIDE_BanditConversationTrigger_db3aded6-8dc3-4072-958b-cc83d012a9e7)
AND
NOT DB_InRegion(_Player, S_CHA_OUTSIDE_BanditConversationTriggerFromInside_e0640487-aab3-4e91-b356-a98ab73d10fe)
AND
NOT DB_InRegion(_Player, S_CHA_OUTSIDE_BanditConversationTriggerFromWest_609e42e9-ca90-4a56-aee6-f645084139c9)
THEN
PROC_TryStartAD((DIALOGRESOURCE)CHA_Outside_AD_BanditReaction_ef416fe4-82f5-1846-c7f0-dabb0d7443bc, _Bandit);
PROC_CHA_BanditsStartFight((CHARACTER)_Bandit, (CHARACTER)_Player);
//END_REGION

//REGION Combat with outside bandit
IF
DB_CHA_OutsideBandits(_Bandit)
THEN
DB_SceneManager(_Bandit, "CHA_OutsideBandit");

PROC
PROC_SceneInterrupted(_Bandit, _Player, "CHA_OutsideBandit","Attacked")
THEN
PROC_CHA_BanditsEndScene();

PROC
PROC_SceneInterrupted(_Bandit, _Player, "CHA_OutsideBandit", "Died")
THEN
PROC_CHA_BanditsEndScene();

IF
PlatformDestroyed(S_PLT_CHA_OUTSIDE_FissureFloor_ee993520-86b7-4d75-a66d-818d9aeb4398)
THEN
PROC_CHA_BanditsEndScene();

PROC
PROC_CHA_BanditsStartFight((CHARACTER)_Bandit, (CHARACTER)_Player)
AND
DB_CHA_OutsideBandits(_Bandits)
THEN
PROC_ForceStopSpecificDialog(_Bandits, CHA_Outside_BanditInteraction_255e9f17-5a10-d273-f504-5d0d414b84e2);
SetFlag((FLAG)CHA_OUTSIDE_Event_Bandit_StopSpotting_0cd56731-7d2e-4d10-956e-c5e20d337710, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_CHA_BanditsEndScene();

PROC
PROC_CHA_BanditsStartFight((CHARACTER)_Bandit, (CHARACTER)_Player)
AND
DB_PartyFollowers(_Player)
THEN
PROC_MakeNPCHostile(_Bandit, _Player);

PROC
PROC_CHA_BanditsEndScene()
THEN
PROC_SceneOver("CHA_OutsideBandit");

PROC
PROC_CHA_BanditsEndScene()
AND
NOT DB_GlobalFlag(CHA_OUTSIDE_Event_BanditScared_afe707eb-108a-d6c0-3c32-69c3eb12a589)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_CHA_GraveDiggersOutside_1ea09ba8-7fc0-27e4-59b3-ffdef4956d6d, 0);

PROC
PROC_CHA_BanditsEndScene()
AND
DB_CHA_OutsideBanditsDialogues(_Dialog)
THEN
PROC_ForceStopSpecificDialog(S_CHA_Exterior_Bandit_Melee_01_538e38b9-e3a4-452a-8369-60eb1fe8c40d, _Dialog);

PROC
PROC_SceneOver("CHA_OutsideBandit")
THEN
ClearFlag(CHA_Outside_State_BanditIdleScene_4242a524-7cd9-4e62-9ddc-14324923e3a7, S_CHA_Exterior_Bandit_Melee_01_538e38b9-e3a4-452a-8369-60eb1fe8c40d);
ClearFlag(CHA_Outside_State_BanditIdleScene_4242a524-7cd9-4e62-9ddc-14324923e3a7, S_CHA_Exterior_Bandit_Melee_02_b5c913f9-f081-45bd-8e95-e34d0735b645);

IF
EnteredCombat(_Bandit, _)
AND
DB_CHA_OutsideBandits((CHARACTER)_Bandit)
AND
DB_SceneManager(_, "CHA_OutsideBandit")
THEN
PROC_CHA_BanditsEndScene();
//END_REGION

//REGION Dialog with outside bandit
QRY
QRY_SelectCustomDialog(S_CHA_Exterior_Bandit_Ranger_01_fa1a1fbd-2152-40e4-b53d-29e95d54279e, _Player)
THEN
PROC_CHA_StartBanditDialog((CHARACTER)_Player, S_CHA_Exterior_Bandit_Ranger_01_fa1a1fbd-2152-40e4-b53d-29e95d54279e);

PROC
PROC_CHA_StartBanditDialog((CHARACTER)_Player, (CHARACTER)_Bandit)
THEN
SetHasDialog(S_CHA_Exterior_Bandit_Ranger_01_fa1a1fbd-2152-40e4-b53d-29e95d54279e, 0);

PROC
PROC_CHA_StartBanditDialog((CHARACTER)_Player, (CHARACTER)_Bandit)
AND
NOT DB_OnlyOnce("CHA_DialogWithOutsideBandits")
AND
QRY_StartDialog((DIALOGRESOURCE)CHA_Outside_BanditInteraction_255e9f17-5a10-d273-f504-5d0d414b84e2, 
				S_CHA_Exterior_Bandit_Melee_01_538e38b9-e3a4-452a-8369-60eb1fe8c40d, 
				S_CHA_Exterior_Bandit_Melee_02_b5c913f9-f081-45bd-8e95-e34d0735b645, 
				_Player)
AND
QRY_OnlyOnce("CHA_DialogWithOutsideBandits")
THEN
DB_NOOP(1);

IF
DialogRequestFailed(CHA_Outside_BanditInteraction_255e9f17-5a10-d273-f504-5d0d414b84e2, _)
THEN
NOT DB_OnlyOnce("CHA_DialogWithOutsideBandits");

IF
DialogEnded(CHA_Outside_BanditInteraction_255e9f17-5a10-d273-f504-5d0d414b84e2, _)
THEN
SetFlag((FLAG)CHA_OUTSIDE_Event_Bandit_StopSpotting_0cd56731-7d2e-4d10-956e-c5e20d337710, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_CHA_StartBanditDialog((CHARACTER)_Player, (CHARACTER)_Bandit)
AND
NOT DB_OnlyOnce("CHA_DialogWithOutsideBandits")
THEN
PROC_CHA_BanditsStartFight(_Bandit, _Player);

PROC
PROC_CHA_StartBanditDialog_FromInside((CHARACTER)_Player, (CHARACTER)_Bandit)
THEN
SetHasDialog(S_CHA_Exterior_Bandit_Ranger_01_fa1a1fbd-2152-40e4-b53d-29e95d54279e, 0);

PROC
PROC_CHA_StartBanditDialog_FromInside((CHARACTER)_Player, (CHARACTER)_Bandit)
AND
NOT DB_OnlyOnce("CHA_DialogWithOutsideBandits")
AND
DB_CHA_OutsideBandits_SpeakerSlot(_Bandit)
THEN
DB_CHA_OutsideBandits_AddToDialog(_Bandit);

PROC
PROC_CHA_StartBanditDialog_FromInside((CHARACTER)_Player, (CHARACTER)_Bandit)
AND
NOT DB_OnlyOnce("CHA_DialogWithOutsideBandits")
AND
QRY_StartDialog(CHA_Outside_BanditBackInteraction_Spotted_d8ea2e7b-10d2-203c-2a8e-ec195a9893da, S_CHA_Exterior_Bandit_Melee_01_538e38b9-e3a4-452a-8369-60eb1fe8c40d, S_CHA_Exterior_Bandit_Melee_02_b5c913f9-f081-45bd-8e95-e34d0735b645, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _Player)
AND
QRY_OnlyOnce("CHA_DialogWithOutsideBandits")
THEN
DB_NOOP(1);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CHA_Outside_BanditBackInteraction_Spotted_d8ea2e7b-10d2-203c-2a8e-ec195a9893da,(INTEGER)_Inst)
AND
DB_CHA_OutsideBandits_AddToDialog(_Bandit)
THEN
NOT DB_CHA_OutsideBandits_AddToDialog(_Bandit);
PROC_DialogAddSpeakingActor(_Inst, _Bandit);

PROC
PROC_CHA_StartBanditDialog_FromInside((CHARACTER)_Player, (CHARACTER)_Bandit)
AND
DB_CHA_OutsideBandits_AddToDialog(_Bandit)
THEN
NOT DB_CHA_OutsideBandits_AddToDialog(_Bandit);

IF
DialogRequestFailed(CHA_Outside_BanditBackInteraction_Spotted_d8ea2e7b-10d2-203c-2a8e-ec195a9893da, _)
THEN
NOT DB_OnlyOnce("CHA_DialogWithOutsideBandits");

IF
DialogEnded(CHA_Outside_BanditBackInteraction_Spotted_d8ea2e7b-10d2-203c-2a8e-ec195a9893da, _)
THEN
SetFlag((FLAG)CHA_OUTSIDE_Event_Bandit_StopSpotting_0cd56731-7d2e-4d10-956e-c5e20d337710, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_CHA_StartBanditDialog_FromInside((CHARACTER) _Player,(CHARACTER) _Bandit)
AND
NOT DB_OnlyOnce("CHA_DialogWithOutsideBandits")
THEN
PROC_CHA_BanditsStartFight(_Bandit,_Player);

PROC
PROC_CHA_StartBanditDialog_FromWest((CHARACTER) _Player)
AND
NOT DB_OnlyOnce("CHA_DialogWithOutsideBandits")
AND
QRY_StartDialog((DIALOGRESOURCE)CHA_Outside_BanditWestInteraction_89b6d80a-0882-1c67-ba7f-5e68daf2165b, 
					S_CHA_Exterior_Bandit_Ranger_01_fa1a1fbd-2152-40e4-b53d-29e95d54279e, 
					S_CHA_Exterior_Bandit_Melee_01_538e38b9-e3a4-452a-8369-60eb1fe8c40d,
					S_CHA_Exterior_Bandit_Melee_02_b5c913f9-f081-45bd-8e95-e34d0735b645, 
					S_CHA_Exterior_Bandit_Caster_01_0f4300f6-0e1e-4d6c-a582-5da588d64ea7,
					_Player)
AND
QRY_OnlyOnce("CHA_DialogWithOutsideBandits")
THEN
DB_NOOP(1);

PROC
PROC_CHA_StartBanditDialog_FromWest((CHARACTER) _Player)
AND
NOT DB_OnlyOnce("CHA_DialogWithOutsideBandits")
THEN
PROC_CHA_BanditsStartFight(S_CHA_Exterior_Bandit_Ranger_01_fa1a1fbd-2152-40e4-b53d-29e95d54279e, _Player);

IF
FlagSet(CHA_Outside_Event_RangerCallsOthers_429a6301-8a55-ca51-1e52-6b4f9b67ce29, _, _)
THEN
PROC_CharacterMoveTo(S_CHA_Exterior_Bandit_Melee_01_538e38b9-e3a4-452a-8369-60eb1fe8c40d, S_CHA_Exterior_Bandit_Melee_01_WestPos_3e5a205b-86c1-4b04-a8b5-970456e912e8, "Run", "");
PROC_CharacterMoveTo(S_CHA_Exterior_Bandit_Melee_02_b5c913f9-f081-45bd-8e95-e34d0735b645, S_CHA_Exterior_Bandit_Melee_02_WestPos_0c1cf865-c9b6-428f-b97a-c6c767f6ee20, "Run", "");

IF
DialogEnded(_Dialog, _)
AND
DB_CHA_OutsideBanditsDialogues(_Dialog)
AND
DB_GlobalFlag((FLAG)CHA_OUTSIDE_Event_BanditScared_afe707eb-108a-d6c0-3c32-69c3eb12a589)
AND
DB_CHA_OutsideBandits(_Char)
AND
NOT DB_PermaDefeated(_Char)
THEN
ApplyStatus(_Char, "PEACEFUL_RESOLUTION_XP", -1.0, 1); // Bandits leave - peaceful resolution
PROC_NotifyWhenReadyToMoveOn(_Char, "CHA_Chapel_BanditLeaves");

PROC
PROC_ReadyToMoveOn(_Char, "CHA_Chapel_BanditLeaves")
THEN
PROC_CharacterMoveTo(_Char, S_CHA_OUTSIDE_Dissapear_Trigger_e8e2fa0d-28fe-47bf-9005-897be61bee20, "Sprint", "CHA_Chapel_BanditLeaves");

IF
EntityEvent(_Char, "CHA_Chapel_BanditLeaves")
THEN
PROC_DisappearOutOfSightTo((CHARACTER)_Char, S_CHA_OUTSIDE_Dissapear_Trigger_e8e2fa0d-28fe-47bf-9005-897be61bee20, "Sprint", 0, "");

IF
DialogEnded(_Dialog,_ID)
AND
DB_CHA_OutsideBanditsDialogues(_Dialog)
AND
DB_GlobalFlag((FLAG)CHA_OUTSIDE_Event_BanditScared_afe707eb-108a-d6c0-3c32-69c3eb12a589)
AND
DB_DialogPlayers(_ID,_Player,1)
THEN
SetFlag((FLAG)CHA_OUTSIDE_Event_Bandit_StopSpotting_0cd56731-7d2e-4d10-956e-c5e20d337710, NULL_00000000-0000-0000-0000-000000000000, 0);
ObjectTimerLaunch(_Player, "CHA_OUTSIDE_Event_BanditScared_ReactionAD_Timer", 2000);

IF
ObjectTimerFinished(_Player, "CHA_OUTSIDE_Event_BanditScared_ReactionAD_Timer")
AND
GetClosestAlivePlayer(_Player, _Companion, _Dist)
AND
_Dist < 12.0
AND
QRY_SpeakerIsAvailable(_Companion)
THEN
StartVoiceBark(CHA_Outside_VB_BanditsLeaveReaction_60eb20bd-df55-d649-17e4-460fd005a782,_Companion);
//END_REGION

//REGION Interacting with the upper entrance (outside)
IF
UseFinished(_Player, S_CHA_OUTSIDE_Entrance_Door_000_2647dac6-234b-4e6f-8321-f88e95359fc4, 0)
AND
IsLocked(S_CHA_OUTSIDE_Entrance_Door_000_2647dac6-234b-4e6f-8321-f88e95359fc4, 1)
AND
NOT DB_CHA_UpperLevelGuardBusy(1)
AND
DB_InRegion(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a, S_CHA_FL0_AndornEntranceDoorDialog_9f560f72-9e1a-4e01-b660-c3da71638d9e)
AND
NOT DB_CantTalk(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a)
AND
NOT DB_CantTalk(_Player)
AND
HasActiveStatus(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a, "CRIME_DISTRACTED", 0)
AND
QRY_StartDialog_Fixed(CHA_Outside_EntranceDoor_c6ab2cbd-4d56-e595-5a6e-cdef7c1719e5, S_CHA_Exterior_AndornHelper_718b0aa6-c8bd-42f0-b1fb-2870c563150b, _Player)
THEN
DB_CHA_UpperLevelGuardBusy(1);
DB_SceneManager(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a, "CHA_DoorGuardDialog");
DB_SceneTriggerManager("CHA_DoorGuardDialog", (TRIGGER)S_CHA_FL0_AndornEntranceScene_29b9ded0-4799-4f00-b7bb-510a9b29a415);
DB_SceneAllowAllDisturbances("CHA_DoorGuardDialog");

PROC
PROC_SceneInterrupted(_, _, "CHA_DoorGuardDialog", _)
THEN
PROC_SceneOver("CHA_DoorGuardDialog");

PROC
PROC_SceneOver("CHA_DoorGuardDialog")
AND
DB_DialogName(CHA_Outside_EntranceDoor_c6ab2cbd-4d56-e595-5a6e-cdef7c1719e5, _)
THEN
PROC_ForceStopDialog(S_CHA_Exterior_AndornHelper_718b0aa6-c8bd-42f0-b1fb-2870c563150b);

IF
DialogEnded(CHA_Outside_EntranceDoor_c6ab2cbd-4d56-e595-5a6e-cdef7c1719e5, _)
AND
DB_GlobalFlag(CHA_Outside_Event_DoorGuardConvinced_563a04db-2f33-4320-883d-d6eccb7e524b)
THEN
ClearFlag(CHA_Outside_Event_DoorGuardConvinced_563a04db-2f33-4320-883d-d6eccb7e524b, NULL_00000000-0000-0000-0000-000000000000); //Global flag
SetFlag(CHA_FL1_State_GuardWaitingAlly_da0d67f6-991f-47ba-b835-e7b8d52b5eaa, NULL_00000000-0000-0000-0000-000000000000); //Global flag
Unlock(S_CHA_OUTSIDE_Entrance_Door_000_2647dac6-234b-4e6f-8321-f88e95359fc4);
Unlock(CHA_FL1_Entrance_Door_4aa7744b-0267-4fae-ac4c-987c77d8977b);

IF
DialogEnded(CHA_Outside_EntranceDoor_c6ab2cbd-4d56-e595-5a6e-cdef7c1719e5, _)
AND
DB_GlobalFlag(CHA_Outside_Event_DoorGuardAfraid_2d969355-6b6c-4cf9-980d-329dcdd4d2ad)
THEN
PROC_CHA_FL1_BanditForceActive(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a);
SetEntityEvent(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a, "CHA_FL1_StartLockDown");
PROC_SetRelationToPlayers((FACTION)ACT1_CHA_DoorGuard_db8c6179-45b9-4a3c-843b-6898572c73d6, 0);
PROC_SpotPlayers_StopSpotting(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a, "CHA_InsideBanditSpotter");
SetCombatGroupID(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a, "CHA_CorridorEncounter");

IF
DialogEnded(CHA_Outside_EntranceDoor_c6ab2cbd-4d56-e595-5a6e-cdef7c1719e5, _)
AND
NOT DB_GlobalFlag(CHA_Outside_Event_DoorGuardConvinced_563a04db-2f33-4320-883d-d6eccb7e524b)
AND
NOT DB_GlobalFlag(CHA_Outside_Event_DoorGuardAfraid_2d969355-6b6c-4cf9-980d-329dcdd4d2ad)
AND
NOT DB_GlobalFlag(CHA_Outside_State_Debris_PillarFell_43c4727c-62fe-6361-9cd2-c9cdd677aca4)
THEN
NOT DB_CHA_UpperLevelGuardBusy(1);

IF
DialogEnded(CHA_Outside_EntranceDoor_c6ab2cbd-4d56-e595-5a6e-cdef7c1719e5, _)
THEN
PROC_SceneOver("CHA_DoorGuardDialog");
//END_REGION

//THE BOULDER
//REGION Before the fall
IF
UseStarted(_Player, CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990)
THEN
StartVoiceBark(CHA_Outside_VB_Boulder_c92eb8c7-21c1-cd86-d48d-1eaec93c9c14, _Player);

IF
UseStarted(_Player, S_CHA_OUTSIDE_Fissure_Crack_f68d6e47-5f97-4dda-be86-8e029d047f48) 
THEN
StartVoiceBark(CHA_Outside_VB_Fissure_e2d5269a-5be6-dfd7-60ee-4ec903ad4d77, _Player);

IF
ItemEnteredTrigger(_Item, S_CHA_Outside_HoleTrigger_de003198-dc27-4180-a0c6-3cb299367fa1, _)
AND
Exists(_Item,1)
THEN
DB_CHA_ItemOverHole(_Item);

IF
ItemLeftTrigger(_Item, S_CHA_Outside_HoleTrigger_de003198-dc27-4180-a0c6-3cb299367fa1, _)
THEN
NOT DB_CHA_ItemOverHole(_Item);

IF
ItemEnteredTrigger(_Item,S_CHA_OUTSIDE_Fissure_DamageTrigger_bc19692f-7418-4556-adad-d132d0b56fdd,_)
AND
Exists(_Item,1)
THEN
DB_CHA_Boulder_ItemAbove(_Item);

IF
ItemLeftTrigger(_Item,S_CHA_OUTSIDE_Fissure_DamageTrigger_bc19692f-7418-4556-adad-d132d0b56fdd,_)
THEN
NOT DB_CHA_Boulder_ItemAbove(_Item);
//END_REGION

//REGION The fall (old but needed logic)
IF
EntityEvent(S_CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990, "CHA_Outside_State_DebrisPillarImpact")
AND
DB_CHA_Boulder_ItemAbove(_Item)
AND
NOT DB_CHA_ItemOverHole(_Item)
THEN
PROC_CHA_DamagedByBoulder((GUIDSTRING)_Item);

IF
EntityEvent(S_CHA_FL1_Fissure_Boulder_000_a27427a2-cc8f-4f82-b611-ea11457d2ba9, "CHA_Outside_Event_SendToCrash")
THEN
SetFlag(CHA_FL1_State_BanditsGoToCrash_4f46902a-3d8a-40bd-a31f-af557ce1811a, NULL_00000000-0000-0000-0000-000000000000);

IF
EntityEvent(S_CHA_FL1_Fissure_Boulder_000_a27427a2-cc8f-4f82-b611-ea11457d2ba9, "CHA_Outside_Event_SendToCrash")
AND
DB_CHA_InsideBandits(_Bandit, _)
AND
_Bandit != S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a
THEN
PROC_CHA_FL1_SendToCrashPos(_Bandit);

PROC
PROC_CHA_FL1_SendToCrashPos((CHARACTER)_Bandit)
THEN
SetEntityEvent(_Bandit, "CHA_EnemyAtTheCrash", 1);
PROC_CHA_FL1_BanditForceActive(_Bandit);
PROC_SpotPlayers_StopSpotting(_Bandit, "CHA_InsideBanditSpotter");
SetCombatGroupID(_Bandit, "CHA_CorridorEncounter");

//END_REGION

//REGION The NEW Fall
// Boulder directly attacked
IF
AttackedBy(S_CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990, _AttackOwner, _, _DamageType, _, _, _)
AND
DB_CHA_Chapel_ValidBoulderDamageTypes(_DamageType)
THEN
PROC_CHA_DestroyPillar((CHARACTER)_AttackOwner);

// Vines
IF
DestroyedBy(S_CHA_OUTSIDE_Fissure_GrapplingVines_001_c64eb1e0-cb5a-46a6-af3f-7bf2b2505e84, _, _DestroyerOwner, _)
THEN
PROC_CHA_DestroyPillar(_DestroyerOwner);

PROC
PROC_CHA_DestroyPillar((CHARACTER)_Attacker)
AND
QRY_OnlyOnce("CHA_Boulder_AttackerAssigned")
THEN
NOT DB_CHA_BoulderAttacker(NULL_00000000-0000-0000-0000-000000000000);
DB_CHA_BoulderAttacker(_Attacker);

PROC
PROC_CHA_DestroyPillar((CHARACTER)_Attacker)
AND
QRY_OnlyOnce("CHA_PillarFall")
THEN
SetGravity(S_CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990, GRAVITYTYPE.Enabled);
PlaySound(S_CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990, "SE_S_CHA_OUTSIDE_Fissure_Boulder_Fall");

PROC
PROC_CHA_DestroyPillar((CHARACTER)_Attacker)
AND
IsDestroyed(CHA_OUTSIDE_Fissure_GrapplingVines_001_c64eb1e0-cb5a-46a6-af3f-7bf2b2505e84, 0)
THEN
Die((ITEM)CHA_OUTSIDE_Fissure_GrapplingVines_001_c64eb1e0-cb5a-46a6-af3f-7bf2b2505e84);

//Case the boulder falls on the platform
IF
Fell(S_CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990, _)
AND
IsInTrigger(S_CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990, S_CHA_Outside_BoulderTrigger_302cbb0d-fea6-493d-b997-baa10b3e607d, 1)
THEN
PROC_CHA_BoulderImpact();
DestroyPlatform(S_PLT_CHA_OUTSIDE_FissureFloor_ee993520-86b7-4d75-a66d-818d9aeb4398);

//Case for heavy object on top of it
IF
DualEntityEvent(_, _, "CHA_Outside_HeavyObjectOnPlatform")
THEN
DestroyPlatform(S_PLT_CHA_OUTSIDE_FissureFloor_ee993520-86b7-4d75-a66d-818d9aeb4398);

//Pillar aboveground animation
PROC
PROC_CHA_BoulderImpact()
THEN
SetFlag((FLAG)CHA_Outside_State_Debris_PillarFell_43c4727c-62fe-6361-9cd2-c9cdd677aca4, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
PlayEffect(S_CHA_Outside_BoulderImpactFX_34ad3704-84c3-4bed-8493-a5eae5cd2a1b, (EFFECTRESOURCE)VFX_Script_Chapel_Outside_Boulder_Impact_Floor_01_c921db60-ed5f-42dd-2f78-2181b8686a2d);
TriggerLaunchIterator(S_CHA_OUTSIDE_Fissure_DamageTrigger_bc19692f-7418-4556-adad-d132d0b56fdd, "CHA_Outside_CheckDestructionAbove", "");
TriggerUnregisterForItems(S_CHA_Outside_HoleTrigger_de003198-dc27-4180-a0c6-3cb299367fa1);
TriggerUnregisterForItems(S_CHA_OUTSIDE_Fissure_DamageTrigger_bc19692f-7418-4556-adad-d132d0b56fdd);
TriggerUnregisterForItems(S_CHA_FL1_Fissure_DamageTrigger_df060f8d-7c3f-49af-874b-eb869c1f0056);
SetEntityEvent(S_CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990, "CHA_Outside_State_DebrisPillarImpact", 1);

IF 
PlatformDestroyed(S_PLT_CHA_OUTSIDE_FissureFloor_ee993520-86b7-4d75-a66d-818d9aeb4398)
THEN
SetEntityEvent(S_CHA_FL1_Fissure_Boulder_000_a27427a2-cc8f-4f82-b611-ea11457d2ba9, "CHA_Outside_Event_SendToCrash", 1);
SetOnStage(S_CHA_OUTSIDE_Fissure_Crack_f68d6e47-5f97-4dda-be86-8e029d047f48, 0);
SetOnStage(S_CHA_FL1_FissureFloor_ShadowProxy_9ef96ad1-e324-4e51-bf9c-810b1206d651, 0);
SetOnStage(S_CHA_FL1_FissureFloor_5c6af29d-dce4-43c8-8192-ad4493a3297a, 1);

IF
PlatformDestroyed(S_PLT_CHA_OUTSIDE_FissureFloor_ee993520-86b7-4d75-a66d-818d9aeb4398)
THEN
DB_CHA_Chapel_RegisterPlatformDestroyedCrime(1);

IF
DB_CHA_Chapel_RegisterPlatformDestroyedCrime(1)
AND
DB_InRegion(_Char, S_CHA_Crypt_SUB_001_f8bc812e-1cb3-46bd-942a-9f572f66ef16)
AND
DB_PartyMembers(_Char)
AND
QRY_OnlyOnce("CHA_PlatformDestroyedCrimeRegistered")
AND
GetPosition(S_CHA_FL1_Fissure_EntranceTrigger_95e04f48-346c-4747-a0fd-598535a8f642, _X, _Y, _Z)
AND
CrimeGetNewID(_CrimeID)
THEN
NOT DB_CHA_Chapel_RegisterPlatformDestroyedCrime(1);
DB_CRIME_CrimeInvestigationPos(_CrimeID, _X, _Y, _Z);
DB_CHA_PlatformDestroyedCrime(_CrimeID);
PROC_CharacterRegisterCrimeWithPosition(_Char, "CHA_Chapel_PlatformDestroyed", NULL_00000000-0000-0000-0000-000000000000, _X, _Y, _Z, NULL_00000000-0000-0000-0000-000000000000, _CrimeID);

IF
OnCrimeInvestigatorSwitchedState(_CrimeID, _Investigator, _, "Idle")
AND
DB_CHA_PlatformDestroyedCrime(_CrimeID)
THEN
SetEntityEvent(_Investigator, "ClearPeaceReturn", 1);

PROC
PROC_CharacterRegisterCrime_Success(_, "CHA_Chapel_PlatformDestroyed", _, _, _, _CrimeID)
THEN
CrimeIgnoreCrime(_CrimeID, S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a);

//Pillar Underground
PROC
PROC_CHA_BoulderImpact_Underground()
THEN
SetOnStage(S_CHA_FL1_Fissure_Boulder_000_a27427a2-cc8f-4f82-b611-ea11457d2ba9, 1);
PROC_CameraShakeAroundObject(S_CHA_FL1_Fissure_Boulder_000_a27427a2-cc8f-4f82-b611-ea11457d2ba9, 100, 30.0);
PROC_TriggerRegisterForPlayers(S_CHA_BanditsCrashBanter_580dea55-345e-4681-8164-8d62ebcd809a);
PROC_SetRelationToPlayers((FACTION)ACT1_CHA_GraveDiggersInside_5bc81140-3a1b-4d5b-b886-26c3d762fa0b, 0);

// If no party member is in the floor where the bandits are, teleport
IF
WentOnStage(S_CHA_FL1_Fissure_Boulder_000_a27427a2-cc8f-4f82-b611-ea11457d2ba9, 1)
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger(S_CHA_FL1_Fissure_BoulderPartyTrigger_bc6920e7-9d41-4a71-b2bb-18584e71400c)
THEN
TeleportTo(S_CHA_FL1_Fissure_Boulder_000_a27427a2-cc8f-4f82-b611-ea11457d2ba9, S_CHA_FL1_Fissure_TeleportBoulderTo_149bd9eb-eca9-48ad-8a9a-bf86d4423098);

IF
WentOnStage(S_CHA_FL1_Fissure_Boulder_000_a27427a2-cc8f-4f82-b611-ea11457d2ba9, 1)
THEN
PROC_TriggerUnregisterForParty(S_CHA_FL1_Fissure_BoulderPartyTrigger_bc6920e7-9d41-4a71-b2bb-18584e71400c);

// As soon as it is set on stage destroy it
IF
WentOnStage(S_CHA_FL1_FissureFloor_5c6af29d-dce4-43c8-8192-ad4493a3297a, 1)
THEN
Die(S_CHA_FL1_FissureFloor_5c6af29d-dce4-43c8-8192-ad4493a3297a, DEATHTYPE.Physical, 0);
//END_REGION

//REGION Iterator from fall : what happens to stuffs on the path of the boulder
//If the player is underneath the falling area then the player takes damage from the collision
IF
EntityEvent(_Char, "CHA_Outside_CheckDestructionAbove")
AND
NOT DB_Dead((CHARACTER)_Char)
THEN
PROC_CHA_DamagedByBoulder((GUIDSTRING)_Char);
ObjectTimerLaunch(_Char, "CHA_Outside_CheckDeadFromPillar", 500);

IF
EntityEvent(_Char, "CHA_Outside_CheckDestructionAbove")
AND
GetFaction(_Char, _Faction)
AND
GetClosestPlayer(_Char, _Player, _)
AND
NOT DB_PartyMembers((CHARACTER)_Char)
THEN
PROC_SetHostileToIndivPlayerFaction(_Faction, _Player);

IF
ObjectTimerFinished(_Char, "CHA_Outside_CheckDeadFromPillar")
AND
DB_CHA_OutsideBandits((CHARACTER)_Char)
AND
DB_Dead(_Char)
THEN
SetFlag(CHA_Outside_State_BanditGotCrushed_fa9d040b-5eeb-4968-a6b3-2f47b644ddd4, NULL_00000000-0000-0000-0000-000000000000);

//If a character or an object is over the hole when the pillar fall, it end up inside the crypt
IF
EntityEvent(_Object, "CHA_Outside_CheckFallingBodies")
AND
_Object != S_CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990
AND
GetPosition(_Object, _ObjectX, _ObjectY, _ObjectZ)
AND
GetPosition(S_CHA_Outside_HoleTrigger_de003198-dc27-4180-a0c6-3cb299367fa1, _InX, _InY, _InZ)
AND
GetPosition(S_CHA_FL1_Fissure_EntranceTrigger_95e04f48-346c-4747-a0fd-598535a8f642, _OutX, _OutY, _OutZ)
AND //Computation of: _CharPosition - _InPosition + _OutPosition
RealSum(_ObjectX, _OutX, _InterX)
AND
RealSubtract(_InterX, _InX, _EndX)
AND
RealSum(_ObjectY, _OutY, _InterY)
AND
RealSubtract(_InterY, _InY, _EndY)
AND
RealSum(_ObjectZ, _OutZ, _InterZ)
AND
RealSubtract(_InterZ, _InZ, _EndZ)
THEN
TeleportToPosition(_Object, _EndX, _EndY, _EndZ, "CHA_FalledFromPillarCrash", 0, 0, 1);

IF
EntityEvent(_Item, "CHA_FalledFromPillarCrash")
AND
DB_CHA_ItemOverHole((ITEM)_Item)
THEN
PROC_CHA_DamagedByBoulder(_Item);

PROC
PROC_CHA_DamagedByBoulder((GUIDSTRING) _Object)
AND
DB_CHA_BoulderAttacker(_Attacker)
THEN
ApplyDamage(_Object, 50, "Physical", _Attacker);
//END_REGION

//REGION Jumping into the hole the boulder made
IF
EnteredTrigger(_Char, S_CHA_OUTSIDE_ChapelJump_a6639952-28a3-437b-99db-5ece12e702d8)
AND
NOT DB_Is_InCombat(_Char, _)
THEN
TeleportTo(_Char, S_CHA_FL1_Fissure_EntranceTrigger_95e04f48-346c-4747-a0fd-598535a8f642, "", 1, 1, 1);
SetCombatGroupID(_Char, "");

IF
EnteredTrigger(_Char, S_CHA_OUTSIDE_ChapelJump_a6639952-28a3-437b-99db-5ece12e702d8)
AND
DB_Is_InCombat(_Char, _)
THEN
TeleportTo(_Char, S_CHA_FL1_Fissure_EntranceTrigger_95e04f48-346c-4747-a0fd-598535a8f642, "", 0, 0, 1);
SetCombatGroupID(_Char, "");

IF
ItemEnteredTrigger(_Item, S_CHA_OUTSIDE_ChapelJump_a6639952-28a3-437b-99db-5ece12e702d8, _)
AND
_Item != S_CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990
AND
Exists(_Item,1)
THEN
TeleportTo(_Item, S_CHA_FL1_Fissure_EntranceTrigger_95e04f48-346c-4747-a0fd-598535a8f642, "", 0, 0, 1);

IF
ItemEnteredTrigger(S_CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990, S_CHA_OUTSIDE_ChapelJump_a6639952-28a3-437b-99db-5ece12e702d8, _)
THEN
SetOnStage(S_CHA_OUTSIDE_Fissure_Boulder_29a94ca5-cede-4932-88c5-3942334e4990, 0);
PROC_CHA_BoulderImpact_Underground();
//END_REGION

//LIVING QUARTER
//REGION Inside bandit Spotter behavior
IF
DB_CHA_InsideBandits(_Char, _)
THEN
DB_SpotPlayers(_Char, "CHA_InsideBanditSpotter", (FLAG)NULL_00000000-0000-0000-0000-000000000000, (FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeSummons(_Char, "CHA_InsideBanditSpotter");
DB_SpotPlayers_IncludeFollowers(_Char, "CHA_InsideBanditSpotter");
DB_SpotPlayers_IgnoreCombat(_Char, "CHA_InsideBanditSpotter");

IF
Opened(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10)
AND
CanSee(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10, 1)
AND
DB_InRegion(_Player, S_CHA_BanditLockpickerFromBelowBox_4c11f88e-ec3d-4a40-95f5-f634e56e7b83)
THEN
PROC_SpotPlayers_StopSpotting(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, "CHA_InsideBanditSpotter");
SetEntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, "CHA_BanditSpot_FromBelow");
DB_CHA_SpecialSpot(_Player, S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);

IF
DestroyedBy(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10, _, _, _)
AND
DB_InRegion(_Player, S_CHA_BanditLockpickerFromBelowBox_4c11f88e-ec3d-4a40-95f5-f634e56e7b83)
THEN
PROC_SpotPlayers_StopSpotting(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, "CHA_InsideBanditSpotter");
SetEntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, "CHA_BanditSpot_FromBelow");
DB_CHA_SpecialSpot(_Player, S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);

PROC
PROC_SpotPlayers_Spotted(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, "CHA_InsideBanditSpotter", _Player)
AND
IsOpened(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10, 1)
AND
DB_InRegion(_Player, S_CHA_BanditLockpickerSurpriseBox_09672d3d-e502-422c-a5ab-5901a2de87d4)
THEN
PROC_SpotPlayers_StopSpotting(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, "CHA_InsideBanditSpotter");
SetEntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, "CHA_BanditSpot_Unlock");
DB_CHA_SpecialSpot(_Player, S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);

PROC
PROC_SpotPlayers_Spotted(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, "CHA_InsideBanditSpotter", _Player)
AND
IsDestroyed(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10,1)
AND
DB_InRegion(_Player,S_CHA_BanditLockpickerSurpriseBox_09672d3d-e502-422c-a5ab-5901a2de87d4)
THEN
PROC_SpotPlayers_StopSpotting(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,"CHA_InsideBanditSpotter");
SetEntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,"CHA_BanditSpot_Unlock");
DB_CHA_SpecialSpot(_Player,S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);

PROC
PROC_SpotPlayers_Spotted(_Bandit, "CHA_InsideBanditSpotter", _Player)
AND
DB_CHA_InsideBandits(_Bandit,_AD)
AND
NOT DB_CHA_SpecialSpot(_Player,_Bandit)
THEN
DB_CHA_PlayBanditADDuringCombat(_Bandit, _AD);
PROC_CHA_FL1_BanditForceActive(_Bandit);
SetEntityEvent(_Bandit,"CHA_BanditSpot");

IF
TurnStarted((CHARACTER)_Bandit)
AND
DB_CHA_PlayBanditADDuringCombat(_Bandit, _AD)
AND
NOT QRY_CHA_Chapel_CantPerformCombatAD(_Bandit) //TODO: discuss if we need a DB_Is_Unsconcious() and add characters in the DB to DB_CantAct()
THEN
NOT DB_CHA_PlayBanditADDuringCombat(_Bandit, _AD);
PROC_CHA_FL1_StartBanditDialog(_Bandit, _AD);
SetEntityEventReal(_Bandit, "GLO_CombatWait", 3.0);

QRY
QRY_CHA_Chapel_CantPerformCombatAD((CHARACTER)_Bandit)
AND
DB_StatusGroups_UnconsciousOrEquivalent(_StatusGroup)
AND
HasActiveStatusWithGroup(_Bandit, _StatusGroup, 1)
THEN
DB_NOOP(1);

PROC
PROC_CHA_FL1_StartBanditDialog((CHARACTER)_Bandit, (DIALOGRESOURCE)_AD)
AND
_Bandit != S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a
THEN
PROC_TryStartAD(_AD, _Bandit);

PROC
PROC_CHA_FL1_StartBanditDialog(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a, (DIALOGRESOURCE)_AD)
AND 
NOT DB_CHA_FL1_BlockGuardSurprisedAD(1)
THEN
PROC_TryStartAD(_AD, S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a);
//END_REGION

//REGION Inside bandit ForceUpdate logic
PROC
PROC_CHA_FL1_BanditForceActive((CHARACTER) _Bandit)
AND
DB_CHA_InsideBandits(_Bandit,_)
AND
NOT DB_CHA_InsideBandits_ForceUpdate(_Bandit)
THEN
SetForceUpdate(_Bandit,1);
DB_CHA_InsideBandits_ForceUpdate(_Bandit);

PROC
PROC_CHA_FL1_BanditUnforceActive((CHARACTER) _Bandit)
AND
DB_CHA_InsideBandits(_Bandit,_)
AND
DB_CHA_InsideBandits_ForceUpdate(_Bandit)
THEN
SetForceUpdate(_Bandit,0);
NOT DB_CHA_InsideBandits_ForceUpdate(_Bandit);

PROC
PROC_StateSet_PermaDefeated(_Bandit)
AND
DB_CHA_InsideBandits((CHARACTER)_Bandit,_)
THEN
PROC_CHA_FL1_BanditUnforceActive(_Bandit);

IF
EntityEvent(_Bandit,"CHA_InPosition")
AND
DB_CHA_InsideBandits((CHARACTER) _Bandit,_)
THEN
PROC_CHA_FL1_BanditUnforceActive(_Bandit);

IF
CombatEnded(_ID)
AND
DB_CHA_InsideBandits(_Bandit,_)
AND
DB_Was_InCombat(_Bandit,_ID)
THEN
SetEntityEvent(_Bandit,"ClearPeaceReturn", 1);
PROC_CHA_FL1_BanditForceActive( _Bandit);
//END_REGION

//REGION Guard bandit
IF
UseStarted(_Player,S_CHA_OUTSIDE_Entrance_Door_000_2647dac6-234b-4e6f-8321-f88e95359fc4)
AND
IsLocked(S_CHA_OUTSIDE_Entrance_Door_000_2647dac6-234b-4e6f-8321-f88e95359fc4, 0)
AND
NOT DB_CHA_FL1_BlockGuardSurprisedAD(1)
THEN
PROC_MakeSurprised(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a, 1, 1);
PROC_CHA_FL1_SurpriseGuardBanditAD();

PROC
PROC_CHA_FL1_SurpriseGuardBanditAD()
AND
QRY_StartDialog(CHA_Crypt_AD_BanditGuardSurprised_b48be298-b170-9a3e-a025-868ed281a8a1, S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a)
THEN
DB_CHA_FL1_BlockGuardSurprisedAD(1);

IF
EntityEvent(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a, "CHA_BanditSpot")
THEN
PROC_SpotPlayers_StopSpotting(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a,"CHA_InsideBanditSpotter");
DB_CHA_FL1_BlockGuardSurprisedAD(1);

IF
AutomatedDialogEnded(CHA_Crypt_AD_BanditGuardSurprised_b48be298-b170-9a3e-a025-868ed281a8a1,_)
THEN
SetEntityEvent(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a,"CHA_FL1_StartLockDown");
PROC_CHA_FL1_BanditForceActive(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a);

IF
EntityEvent(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a,"CHA_WarnTheOthers")
THEN
PROC_CHA_FL1_BanditForceActive(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);
PROC_CHA_FL1_BanditForceActive(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7);
PROC_SetRelationToPlayers((FACTION)ACT1_CHA_GraveDiggersInside_5bc81140-3a1b-4d5b-b886-26c3d762fa0b,0);
SetEntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,"CHA_CallForHelp"); // Avoid the lockpicker to call for help again
SetEntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,"CHA_EnnemyAtTheDoor");
SetEntityEvent(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7,"CHA_EnnemyAtTheDoor");
PROC_SpotPlayers_StopSpotting(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,"CHA_InsideBanditSpotter");
PROC_SpotPlayers_StopSpotting(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7,"CHA_InsideBanditSpotter");
SetCombatGroupID(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,"CHA_CorridorEncounter");
SetCombatGroupID(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7,"CHA_CorridorEncounter");
PROC_CHA_FL1_SetSanctumBanditsCombatGroup("CHA_CorridorEncounter");
SetFlag(CHA_FL1_State_BanditsAlerted_1c0232a5-b415-4003-8bcd-dbc5e565c793, NULL_00000000-0000-0000-0000-000000000000);

IF
EntityEvent(_Bandit, "CHA_JoinGuardCombat")
AND
IsInCombat(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a, 1)
THEN
PROC_EnterCombat(_Bandit, S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a);

IF
DB_CHA_UpperCryptTrap(_Trap)
THEN
SetOnStage(_Trap,0);

IF
EntityEvent(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a,"SetTrap")
AND
DB_CHA_UpperCryptTrap(_Trap)
THEN
SetOnStage(_Trap,1);
//END_REGION

//REGION Lockpicking Bandit
IF
Unlocked(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10,_,_)
THEN
PROC_CHA_FL1_BanditForceActive(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);

IF
DestroyedBy(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10,_,_,_)
THEN
PROC_CHA_FL1_BanditForceActive(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);

IF
EntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,"CHA_BanditSpot")
THEN
PROC_CHA_FL1_BanditForceActive(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);
PROC_SetRelationToPlayers((FACTION)ACT1_CHA_Lockpicker_7ebba23a-6c35-442d-8f12-1540d5cfcf47,0);
PROC_TriggerUnregisterForPlayers(S_CHA_BanditLockpickerSurpriseBox_09672d3d-e502-422c-a5ab-5901a2de87d4);
PROC_TriggerUnregisterForPlayers(S_CHA_BanditLockpickerFromBelowBox_4c11f88e-ec3d-4a40-95f5-f634e56e7b83);

IF
EntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,"CHA_BanditSpot")
AND
DB_CHA_SpecialSpot(_Player,S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e)
THEN
NOT DB_CHA_SpecialSpot(_Player,S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);

IF
EntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,"CHA_CallForHelp")
THEN
PROC_CHA_FL1_BanditForceActive(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7);
PROC_SetRelationToPlayers((FACTION)ACT1_CHA_SanctumBandit_7d34754f-50e9-48f2-99f4-875a7b844212,0);
SetEntityEvent(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7,"CHA_EnnemyAtTheCorridor");
PROC_SpotPlayers_StopSpotting(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7,"CHA_InsideBanditSpotter");
SetFlag(CHA_FL1_State_BanditsGoToCorridor_c68ce420-15b7-4845-a92b-0283eb38b443, NULL_00000000-0000-0000-0000-000000000000);

IF
EntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,"CHA_CallForHelp")
AND
DB_Is_InCombat(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, _CombatID)
AND
DB_Is_InCombat(_PartyMember, _CombatID)
AND
NOT DB_OnlyOnce("CHA_Chapel_BanditMovesToParty")
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
NOT QRY_CharacterIsHidden(_PartyMember)
AND
QRY_OnlyOnce("CHA_Chapel_BanditMovesToParty")
THEN
PROC_CHA_Chapel_SendBanditsTo(_PartyMember);

PROC
PROC_CHA_Chapel_SendBanditsTo((CHARACTER)_PartyMember)
AND
GetPosition(_PartyMember, _X, _Y, _Z)
AND
DB_CHA_SanctumBandits(_Bandit)
AND
NOT DB_PermaDefeated(_Bandit)
AND
FindValidPosition(_X, _Y, _Z, 5.0, _Bandit, 1, _ValidX, _ValidY, _ValidZ)
THEN
DB_CHA_Chapel_BanditMovesToCombatArea((CHARACTER)_Bandit, _ValidX, _ValidY, _ValidZ);
PROC_NotifyWhenReadyToMoveOn((CHARACTER)_Bandit, "CHA_Chapel_BanditMoveToCombat");

// Do the same for S_CHA_FL1_BanditSanctum
PROC
PROC_CHA_Chapel_SendBanditsTo((CHARACTER)_PartyMember)
AND
GetPosition(_PartyMember, _X, _Y, _Z)
AND
NOT DB_PermaDefeated(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7)
AND
FindValidPosition(_X, _Y, _Z, 5.0, (CHARACTER)S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7, 1, _ValidX, _ValidY, _ValidZ)
THEN
DB_CHA_Chapel_BanditMovesToCombatArea((CHARACTER)S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7, _ValidX, _ValidY, _ValidZ);
PROC_NotifyWhenReadyToMoveOn((CHARACTER)S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7, "CHA_Chapel_BanditMoveToCombat");

PROC
PROC_ReadyToMoveOn(_Bandit, "CHA_Chapel_BanditMoveToCombat")
AND
DB_CHA_Chapel_BanditMovesToCombatArea(_Bandit, _ValidX, _ValidY, _ValidZ)
THEN
PROC_CharacterMoveToPosition(_Bandit, _ValidX, _ValidY, _ValidZ, "Run", "CHA_Chapel_BanditMoveToCombat");

PROC
PROC_ReadyToMoveOn_Failed(_Bandit, "CHA_Chapel_BanditMoveToCombat")
AND
DB_CHA_Chapel_BanditMovesToCombatArea(_Bandit, _ValidX, _ValidY, _ValidZ)
THEN
NOT DB_CHA_Chapel_BanditMovesToCombatArea(_Bandit, _ValidX, _ValidY, _ValidZ);

IF
EntityEvent((CHARACTER)_Bandit, "CHA_Chapel_BanditMoveToCombat")
AND
DB_CHA_Chapel_BanditMovesToCombatArea(_Bandit, _ValidX, _ValidY, _ValidZ)
THEN
NOT DB_CHA_Chapel_BanditMovesToCombatArea(_Bandit, _ValidX, _ValidY, _ValidZ);

IF
EnteredCombat((CHARACTER)_Bandit, _)
AND
DB_CHA_Chapel_BanditMovesToCombatArea(_Bandit, _ValidX, _ValidY, _ValidZ)
THEN
NOT DB_CHA_Chapel_BanditMovesToCombatArea(_Bandit, _ValidX, _ValidY, _ValidZ);
PROC_ClearStoryMove(_Bandit);

IF
EntityEvent(_, "CHA_CallForHelp_AtCrash")
THEN
PROC_CHA_FL1_SendToCrashPos(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a);

IF
EntityEvent(_Bandit, "CHA_BanditSpot_OpenDoor")
THEN
SetCombatGroupID(_Bandit, "CHA_SanctumBandits");
//END_REGION

//REGION FL1 Banter about the door opening on its own
IF
EntityEvent(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7,"CHA_GoSit")
AND
QRY_OnlyOnce("CHA_StartOpenDoorBanter")
AND
NOT DB_CantTalk(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7)
THEN
DB_CHA_BanditsReadyForOpenDoorAD(1);

IF
DB_CHA_BanditsReadyForOpenDoorAD(1)
AND
DB_InRegion(_,S_CHA_BanditsOpenDoorBanter_609f6042-554a-4490-9484-5089b4ed7eaa)
AND
NOT DB_OnlyOnce("CHA_PillarFall")
AND
QRY_OnlyOnce("CHA_StartOpenDoorBanter")
THEN
TimerCancel("CHA_BanditOpenDoorBanter");
PROC_TryStartAD(CHA_Crypt_AD_BanditOpenDoorBanter_6aab106f-a6e3-2e83-4800-afbe50dc6ab3,S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7);

IF
AutomatedDialogEnded(CHA_Crypt_AD_BanditOpenDoorBanter_6aab106f-a6e3-2e83-4800-afbe50dc6ab3,_ID)
THEN
TimerLaunch("CHA_BanditOpenDoorBanter",2000);
NOT DB_CHA_ODBanterContinue(1);

IF
TimerFinished("CHA_BanditOpenDoorBanter")
AND
DB_InRegion(_,S_CHA_BanditsOpenDoorBanter_609f6042-554a-4490-9484-5089b4ed7eaa)
AND
NOT DB_OnlyOnce("CHA_PillarFall")
AND
NOT DB_Is_InCombat(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,_)
AND
NOT DB_Is_InCombat(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7,_)
AND
GetFlag(CHA_FL1_Event_OpenDoorBanterOver_eb763233-bc60-4ee8-ac32-b4a51c8f674e,NULL_00000000-0000-0000-0000-000000000000,0)
THEN
TimerCancel("CHA_BanditOpenDoorBanter");
PROC_TryStartAD(CHA_Crypt_AD_BanditOpenDoorBanter_6aab106f-a6e3-2e83-4800-afbe50dc6ab3,S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7);
DB_CHA_ODBanterContinue(1);

IF
TimerFinished("CHA_BanditOpenDoorBanter")
AND
NOT DB_CHA_ODBanterContinue(1)
AND
QRY_OnlyOnce_Reset("CHA_StartOpenDoorBanter")
THEN
ClearFlag(CHA_FL1_Event_OpenDoorBanterOver_eb763233-bc60-4ee8-ac32-b4a51c8f674e,NULL_00000000-0000-0000-0000-000000000000);

IF
EnteredCombat(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,_CombatID)
AND
DB_CHA_BanditsReadyForOpenDoorAD(1)
THEN
PROC_ForceStopDialog(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);
TimerCancel("CHA_BanditOpenDoorBanter");

IF
EnteredCombat(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7,_CombatID)
AND
DB_CHA_BanditsReadyForOpenDoorAD(1)
THEN
PROC_ForceStopDialog(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7);
TimerCancel("CHA_BanditOpenDoorBanter");

IF
EntityEvent(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7,"CHA_BanditSpot")
AND
DB_CHA_BanditsReadyForOpenDoorAD(1)
THEN
PROC_SetRelationToPlayers(ACT1_CHA_Lockpicker_7ebba23a-6c35-442d-8f12-1540d5cfcf47,0);
PROC_CHA_FL1_BanditForceActive(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);
SetEntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,"CHA_BanditSpot");
//END_REGION

//REGION FL1 Ambush after the crash
IF
EntityEvent(_Bandit,"CHA_InPositionAtTheCrash")
AND
DB_CHA_InsideBandits((CHARACTER)_Bandit,_)
AND
NOT DB_CHA_BanditsReadyForCrashAD(_Bandit)
THEN
DB_CHA_BanditsReadyForCrashAD(_Bandit);
SetWeaponUnsheathed(_Bandit, 1, 0);
PROC_CHA_FL1_BanditUnforceActive(_Bandit);
SetEntityEvent(_Bandit,"CHA_InPosition");

IF
DB_CHA_BanditsReadyForCrashAD(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a)
AND
DB_CHA_BanditsReadyForCrashAD(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e)
AND
DB_CHA_BanditsReadyForCrashAD(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7)
AND
DB_InRegion(_Player,S_CHA_BanditsCrashBanter_580dea55-345e-4681-8164-8d62ebcd809a)
AND
QRY_OnlyOnce("CHA_StartCrashBanter")
THEN
PROC_TryStartAD(CHA_Crypt_AD_BanditCrashBanter_c106fcb0-651c-e1f3-8f5d-f18884b72761,S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a,S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7);
TimerCancel("CHA_BanditCrashBanter");

IF
AutomatedDialogEnded(CHA_Crypt_AD_BanditCrashBanter_c106fcb0-651c-e1f3-8f5d-f18884b72761,_ID)
THEN
TimerLaunch("CHA_BanditCrashBanter",2000);
NOT DB_CHA_BanterContinue(1);

IF
TimerFinished("CHA_BanditCrashBanter")
AND
DB_CHA_BanditsReadyForCrashAD(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a)
AND
DB_CHA_BanditsReadyForCrashAD(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e)
AND
DB_CHA_BanditsReadyForCrashAD(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7)
AND
DB_InRegion(_Player,S_CHA_BanditsCrashBanter_580dea55-345e-4681-8164-8d62ebcd809a)
AND
NOT DB_Is_InCombat(S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a,_)
AND
NOT DB_Is_InCombat(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,_)
AND
NOT DB_Is_InCombat(S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7,_)
AND
GetFlag(CHA_FL1_Event_CrashBanterOver_af686590-f86f-43c7-9bf0-d8862bd52221,NULL_00000000-0000-0000-0000-000000000000,0)
THEN
PROC_TryStartAD(CHA_Crypt_AD_BanditCrashBanter_c106fcb0-651c-e1f3-8f5d-f18884b72761,S_CHA_FL1_BanditGuard_4000f859-71fe-49ef-8400-da44b6fef92a,S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e,S_CHA_FL1_BanditSanctum_f0945b85-3cfe-4312-b49a-3741b1f0bfc7);
DB_CHA_BanterContinue(1);

IF
TimerFinished("CHA_BanditCrashBanter")
AND
NOT DB_CHA_BanterContinue(1)
AND
QRY_OnlyOnce_Reset("CHA_StartCrashBanter")
THEN
ClearFlag(CHA_FL1_Event_CrashBanterOver_af686590-f86f-43c7-9bf0-d8862bd52221,NULL_00000000-0000-0000-0000-000000000000);

IF
EnteredCombat(_Bandit,_CombatID)
AND
DB_CHA_InsideBandits((CHARACTER)_Bandit,_)
AND
DB_CHA_BanditsReadyForCrashAD(_Bandit)
THEN
PROC_ForceStopDialog(_Bandit);
TimerCancel("CHA_BanditCrashBanter");

IF
UseStarted(_Player,S_CHA_FL1_DoorToBedroom_7d99f551-1c7b-4c12-a0a3-d67b1ed6f91f)
AND
DB_Players(_Player)
AND
DB_CHA_BanditsReadyForCrashAD(_Bandit)
AND
NOT DB_Dead(_Bandit)
THEN
PROC_EnterCombat(_Bandit,_Player);
//END_REGION

//REGION Metal Door
IF
DualEntityEvent(_, (ITEM)_Lever, "CHA_FL1_MetalLeverUsed")
AND
DB_CHA_MetalDoorLever(_Lever)
AND
IsLocked(S_CHA_FL1_MetalGateReplacement_1c9609ee-fc96-4826-bac1-856a609564ac,1)
AND
QRY_OnlyOnce("CHA_MetalDoorLeverUsed")
THEN
PROC_ItemUnlockAndOpen(S_CHA_FL1_MetalGateReplacement_1c9609ee-fc96-4826-bac1-856a609564ac, 0);

IF
DualEntityEvent(_, (ITEM)_Lever, "CHA_FL1_MetalLeverUsed")
AND
DB_CHA_MetalDoorLever(_Lever)
AND
IsLocked(S_CHA_FL1_MetalGateReplacement_1c9609ee-fc96-4826-bac1-856a609564ac,0)
AND
QRY_OnlyOnce("CHA_MetalDoorLeverUsed")
THEN
PROC_ItemCloseAndLock((ITEM)S_CHA_FL1_MetalGateReplacement_1c9609ee-fc96-4826-bac1-856a609564ac, "CHA_MetalDoor");

IF
DualEntityEvent(_, (ITEM)_Lever, "CHA_FL1_MetalLeverUsed")
AND
DB_CHA_MetalDoorLever(_Lever)
AND
QRY_OnlyOnce_Reset("CHA_MetalDoorLeverUsed")
THEN
DB_NOOP(1);

IF
DB_CHA_InsideBandits(_char,_)
THEN
TriggerRegisterForCharacter(S_CHA_WrongSideOfMetalDoor_31f07cf8-ddd6-4622-b6a8-0ed76b87e901,_char);

IF
EnteredTrigger(_char,S_CHA_WrongSideOfMetalDoor_31f07cf8-ddd6-4622-b6a8-0ed76b87e901)
THEN
SetFlag(CHA_FL1_State_WrongSideOfMetalDoor_c8871d03-b737-4201-9368-802e2b437bd0,_char);

IF
LeftTrigger(_char,S_CHA_WrongSideOfMetalDoor_31f07cf8-ddd6-4622-b6a8-0ed76b87e901)
THEN
ClearFlag(CHA_FL1_State_WrongSideOfMetalDoor_c8871d03-b737-4201-9368-802e2b437bd0,_char);
//END_REGION

//REGION Door Between Up and Down and lever
IF
UseStarted(_Player, S_CHA_FL1_InnerSanctumLever_3a666d6f-ac63-42d2-9ef4-56b871803150)
AND
DB_Players(_Player)
AND
QRY_OncePerUserAndNearbyPlayers(_Player,"CHA_FL1_InnerSanctumLever_AD")
THEN
PROC_TryStartAD((DIALOGRESOURCE)GLO_WhatDidThatDo_AD_e0f4869f-3902-00df-1775-28b0bce3c88e, _Player);

IF
UseStarted(_, S_CHA_FL1_InnerSanctumLever_3a666d6f-ac63-42d2-9ef4-56b871803150)
AND
DB_CHA_CandlesPuzzle(_Candle)
AND
HasActiveStatus(_Candle, "BURNING", 0)
THEN
ApplyStatus(_Candle, "BURNING", -1.0, 0);

PROC
PROC_CHA_FL1_WeirdDoorUnlocked()
AND
QRY_OnlyOnce("CHA_StairDoor_Unlocked")
AND
NOT DB_Defeated(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e)
THEN
PROC_CHA_FL1_BanditForceActive(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e);

PROC
PROC_BlockUseOfItem(_Player,S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10)
AND
IsLocked(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10,1)
THEN
QuestUpdate(_Player, "CHA_Chapel", "WeirdDoor");
PROC_TryStartAD(CHA_Crypt_AD_UpDownDoorInvestigation_5339fc90-bc38-c0ef-52dd-d4779105e3b6,_Player);
DB_CustomUseItemResponse(_Player,S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10,0);
//END_REGION

//REGION Sanctum bandits
// When alerted they will move always to the corridor. Set combat group.
IF
FlagSet(CHA_FL1_State_BanditsAlerted_1c0232a5-b415-4003-8bcd-dbc5e565c793, _, _)
THEN
PROC_CHA_FL1_SetSanctumBanditsCombatGroup("CHA_CorridorEncounter");
PROC_CHA_FL1_DoNotFaceBandits();

IF
FlagSet(CHA_FL1_State_BanditsGoToCrash_4f46902a-3d8a-40bd-a31f-af557ce1811a, _, _)
THEN
PROC_CHA_FL1_SetSanctumBanditsCombatGroup("CHA_CorridorEncounter");
PROC_CHA_FL1_DoNotFaceBandits();

IF
FlagSet(CHA_FL1_State_BanditsGoToCorridor_c68ce420-15b7-4845-a92b-0283eb38b443, _, _)
THEN
PROC_CHA_FL1_SetSanctumBanditsCombatGroup("CHA_CorridorEncounter");
PROC_CHA_FL1_DoNotFaceBandits();

PROC
PROC_CHA_FL1_SetSanctumBanditsCombatGroup((STRING)_CombatID)
AND
DB_CHA_SanctumBandits(_Bandit)
THEN
SetCombatGroupID(_Bandit, _CombatID);

// Disable bandits facing each other during ADs.
PROC
PROC_CHA_FL1_DoNotFaceBandits()
AND
DB_CHA_SanctumBandits(_Bandit)
THEN
DB_DoNotFace(_Bandit);

PROC
PROC_CHA_FL1_DoNotFaceBandits()
AND
DB_CHA_InsideBandits(_Bandit, _)
THEN
DB_DoNotFace(_Bandit);
//END_REGION

//CRYPT
//REGION Poison Trap
IF
UseStarted(_Char, S_CHA_TrappedTomb_Lid_PoisonTrap_138fd148-7a23-474e-9737-87e3dca04f9e)
THEN
PROC_CHA_CryptTrap_SetLastUser(_Char);

PROC
PROC_CHA_CryptTrap_SetLastUser((CHARACTER) _Char)
AND
DB_CHA_CryptTrap_LastUser(_PreviousUser)
THEN
NOT DB_CHA_CryptTrap_LastUser(_PreviousUser);

PROC
PROC_CHA_CryptTrap_SetLastUser((CHARACTER) _Char)
THEN
DB_CHA_CryptTrap_LastUser(_Char);

IF
RemovedFrom(_, S_CHA_TrappedTomb_Lid_PoisonTrap_138fd148-7a23-474e-9737-87e3dca04f9e)
THEN
PROC_CHA_CrypTrap_Activate();

IF
UseStarted(_Player, _Item)
AND
NOT DB_CHA_Crypt_TrapActivated(1)
AND
DB_CHA_Crypt_GasPit(_Item)
THEN
StartVoiceBark(CHA_Crypt_VB_GasPit_2131ede4-eb85-f3da-8418-b78c509785ab, (CHARACTER)_Player);

IF
UseStarted(_Player, S_CHA_PUZ_PoisonButton_2f1b1f4f-7d98-43fc-ab2b-f7cefca920d8)
AND
NOT DB_CHA_Crypt_TrapActivated(1)
THEN
PROC_TryStartAD((DIALOGRESOURCE)CHA_Crypt_PAD_ButtonBlocked_e6b7bd9c-dcc5-d347-2423-0628bea2ccb2,_Player);

IF
UseStarted(_Player, S_CHA_PUZ_PoisonButton_2f1b1f4f-7d98-43fc-ab2b-f7cefca920d8)
AND
DB_CHA_Crypt_TrapActivated(1)
THEN
PROC_CHA_CrypTrap_Deactivate();

PROC
PROC_CHA_CrypTrap_Activate()
AND
NOT DB_OnlyOnce("CHA_CryptTrapActivated")
THEN
DB_CHA_Crypt_TrapActivated(1);
SetDualEntityEvent(NULL_00000000-0000-0000-0000-000000000000, S_CHA_TrappedTomb_Lid_PoisonTrap_138fd148-7a23-474e-9737-87e3dca04f9e, "CompassRoom_Gaspit_On");
SetDualEntityEvent(NULL_00000000-0000-0000-0000-000000000000, S_CHA_TrappedTomb_Lid_PoisonTrap_138fd148-7a23-474e-9737-87e3dca04f9e, "ChapelTrapRoom01_On");
SetDualEntityEvent(NULL_00000000-0000-0000-0000-000000000000, S_CHA_TrappedTomb_Lid_PoisonTrap_138fd148-7a23-474e-9737-87e3dca04f9e, "ChapelTrapRoomTurret_On");
PlaySound((ITEM)S_CHA_TrappedTomb_Lid_PoisonTrap_138fd148-7a23-474e-9737-87e3dca04f9e,"SE_CHA_TrappedWall_Mechanism_MO");



PROC
PROC_CHA_CrypTrap_Activate()
AND
QRY_OnlyOnce("CHA_CryptTrapActivated")
AND
DB_CHA_CryptTrap_LastUser(_LastUser)
THEN
ForceTurnBasedMode(_LastUser, 1);

PROC
PROC_CHA_CrypTrap_Deactivate()
THEN
NOT DB_CHA_Crypt_TrapActivated(1);
SetDualEntityEvent(NULL_00000000-0000-0000-0000-000000000000, S_CHA_TrappedTomb_Lid_PoisonTrap_138fd148-7a23-474e-9737-87e3dca04f9e, "CompassRoom_Gaspit_Off");
SetDualEntityEvent(NULL_00000000-0000-0000-0000-000000000000, S_CHA_TrappedTomb_Lid_PoisonTrap_138fd148-7a23-474e-9737-87e3dca04f9e, "ChapelTrapRoom01_Off");
SetDualEntityEvent(NULL_00000000-0000-0000-0000-000000000000, S_CHA_TrappedTomb_Lid_PoisonTrap_138fd148-7a23-474e-9737-87e3dca04f9e, "ChapelTrapRoomTurret_Off");
PROC_TryStartAD(GLO_AD_MechanicalClick_fc8d3dc5-b947-6354-3aa9-d1f02fd51af4, S_CHA_PUZ_PoisonButton_2f1b1f4f-7d98-43fc-ab2b-f7cefca920d8);
//END_REGION

//REGION Secret Door
IF
UseStarted(_Player, S_CHA_FL0_ButtonToSecretDoor_51cdb6e6-e998-46ad-af8c-e6a531654137)
AND
DB_OnlyOnce("CHA_SecretDoor")
THEN
PROC_TryStartAD((DIALOGRESOURCE)CHA_Crypt_PAD_ButtonBlocked_e6b7bd9c-dcc5-d347-2423-0628bea2ccb2,_Player);

IF
UseStarted(_Player, S_CHA_FL0_ButtonToSecretDoor_51cdb6e6-e998-46ad-af8c-e6a531654137)
AND
QRY_OnlyOnce("CHA_SecretDoor")
THEN
SetFlag(CHA_Crypt_State_SecretRoomOpenAndJergalInSarcophagus_0ef70c0c-2da5-4ea1-b7a5-60dd2e0fe65c, NULL_00000000-0000-0000-0000-000000000000);
PROC_TryStartAD(GLO_AD_MechanicalClick_fc8d3dc5-b947-6354-3aa9-d1f02fd51af4, S_CHA_FL0_ButtonToSecretDoor_51cdb6e6-e998-46ad-af8c-e6a531654137);
TimerLaunch("CHA_StartMovingWall", 1500);
PROC_CHA_Desecration(_Player);
TemplateAddTo((ITEMROOT)MAG_Dawn_Morningstar_907df6ab-93ab-4f51-bf57-ac767d48e382, _Player, 1, 1);

//TODO: revisit ALL secret doors made with wall entities and convert them to doors if needed so they can use the portals feature.
IF
TimerFinished("CHA_StartMovingWall")
THEN
Open(S_CHA_Door_SlidingWall_DungeonAbbey_A_001_cb0c8869-6e84-4736-9810-ef997b4dad54);
//END_REGION

//REGION Lights in the secret tomb
IF
DB_CHA_SecretAlcoveLight(_Light)
THEN
SetEntityEvent(_Light,"turnOff", 1);

IF
DB_CHA_SkeletonRoomLight(_Light)
THEN
SetEntityEvent(_Light,"turnOff", 1);

IF
EnteredTrigger(_Player,S_CHA_FL0_LightAlcove_f0524a5a-e38d-484b-9820-cfe37725ff26)
AND
NOT DB_OnlyOnce("CHA_Desecration")
AND
QRY_OnlyOnce("CHA_TurnOnLight")
THEN
TimerLaunch("CHA_TurnOnLight",100);
PROC_TriggerUnregisterForPlayers(S_CHA_FL0_LightAlcove_f0524a5a-e38d-484b-9820-cfe37725ff26);
DB_CHA_EnteredAlcove(1);

IF
EnteredTrigger(_Player,S_CHA_FL0_LightAlcove_f0524a5a-e38d-484b-9820-cfe37725ff26)
AND
NOT DB_OnlyOnce("CHA_JergalRoomJournalUpdate")
AND
NOT DB_CHA_Crypt_JergalLeftTomb(1)
THEN
DB_OnlyOnce("CHA_JergalRoomJournalUpdate");
QuestUpdate(_Player, "CHA_Chapel", "FoundSarcophagus_Sealed");

IF
EnteredTrigger(_Player,S_CHA_FL0_LightAlcove_f0524a5a-e38d-484b-9820-cfe37725ff26)
AND
QRY_OnlyOnce("CHA_JergalRoomJournalUpdate")
AND
DB_CHA_Crypt_JergalLeftTomb(1)
THEN
QuestUpdate(_Player, "CHA_Chapel", "FoundSarcophagus_Opened");

IF
Opened(S_CHA_TrappedTomb_Lid_Artefact_0a4e73ea-a217-4a23-8c4e-1844e93a5ad7)
AND
DB_CHA_Crypt_JergalLeftTomb(1)
AND
NOT DB_QuestIsClosed("CHA_Chapel")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("CHA_Chapel", "ReadSarcophagusPlaque")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("CHA_Chapel", "OpenedSarcophagus")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("CHA_Chapel", "ConfrontJergal")
THEN
QuestUpdate("CHA_Chapel", "FoundSarcophagus_Opened");

IF
TimerFinished("CHA_TurnOnLight")
AND
DB_CHA_SecretAlcoveLight(_Light)
THEN
SetEntityEvent(_Light,"turnOn",1);

PROC
PROC_CHA_TurnAllLightOff()
AND
DB_CHA_SecretAlcoveLight(_Light)
THEN
SetEntityEvent(_Light,"turnOff", 1);

PROC
PROC_CHA_TurnAllLightOff()
AND
DB_CHA_SkeletonRoomLight(_Light)
THEN
SetEntityEvent(_Light,"turnOff", 1);
//END_REGION

//REGION Undead guardians VB
IF
DB_InRegion(_Player, S_CHA_FL0_VB_SkeletonArea_14756f69-b2bd-4608-865a-39cf5999fd05)
AND
DB_Sees(_Player, _Skeleton)
AND
DB_CHA_UndeadGuardian(_Skeleton)
AND
NOT DB_CHA_Crypt_SkeletonsResurrected(1)
AND
QRY_OnlyOnce("CHA_SeenDeadGuardians")
THEN
StartVoiceBark(CHA_FL0_VB_Skeleton_2791f166-5186-a299-13bc-686e321aa4bf, _Player);

IF
VoiceBarkStarted(CHA_FL0_VB_Skeleton_2791f166-5186-a299-13bc-686e321aa4bf, _)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_CHA_FL0_VB_SkeletonArea_14756f69-b2bd-4608-865a-39cf5999fd05);
//END_REGION

//REGION Undead guardians rising
IF
DB_CHA_UndeadGuardian(_Skeleton)
THEN
DB_CanBeResurrected(_Skeleton);
Die(_Skeleton,DEATHTYPE.Physical,NULL_00000000-0000-0000-0000-000000000000,1,1,0.0);

PROC
PROC_BlockPickupOfCharacter(_Char, _Skeleton, _)
AND
DB_CHA_UndeadGuardian(_Skeleton)
AND
DB_CanBeResurrected(_Skeleton)
THEN
DB_CustomPickupCharacterResponse(_Char, _Skeleton, 0);
PROC_CHA_Crypt_ResurrectSkeletonsNoCinematic(_Char);

IF
MovedBy((CHARACTER)_Skeleton, _Char)
AND
DB_CHA_UndeadGuardian(_Skeleton)
AND
DB_CanBeResurrected(_Skeleton)
THEN
PROC_CHA_Crypt_ResurrectSkeletonsNoCinematic(_Char);

PROC
PROC_CHA_Desecration((CHARACTER)_Player)
AND
QRY_OnlyOnce("CHA_Crypt_Desecration")
THEN
DB_CHA_TakerOfArtefact(_Player);
TimerLaunch("CHA_RisingCinematic",500);

PROC
PROC_CHA_Crypt_ResurrectSkeletonsNoCinematic((CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOnce("CHA_Crypt_Desecration")
THEN
StartVoiceBark(CHA_TakingTheArtefact_VB_506e3c7a-a4b0-8e31-8676-f9b40210927d,_Player);

PROC
PROC_CHA_Crypt_ResurrectSkeletonsNoCinematic((CHARACTER)_Player)
AND
QRY_OnlyOnce("CHA_Crypt_Desecration")
THEN
DB_CHA_Crypt_BlockDesecrationCinematic(1);
PROC_TriggerRegisterForPlayers(S_CHA_GuardianFight_e1199dde-3731-4247-bd87-3ffb1f4053f6);
PROC_TriggerUnregisterForPlayers(S_CHA_FL0_RisingCinematicInclusion_f929b9ee-3d22-443e-91ab-8385255dbe8d);
PROC_CHA_TurnAllLightOff();
TimerLaunch("CHA_Crypt_ResurrectNoCinematic", 500); // Wait a bit or thrown skeletons will appear sliding across the floor when resurrected

IF
TimerFinished("CHA_Crypt_ResurrectNoCinematic")
THEN
PROC_CHA_ResurrectAllSkeletons();
PROC_SetRelationToPlayers(ACT1_CHA_CryptGuardian_6ce9503d-92cf-3e01-aa83-6065f22e6747, 0);

IF
TimerFinished("CHA_RisingCinematic")
AND
NOT DB_CHA_Crypt_BlockDesecrationCinematic(1)
AND
DB_CHA_TakerOfArtefact(_Player)
AND
QRY_SpeakerIsAvailable(_Player,0 , 1)
AND
QRY_PrepForInteractiveDialog(CHA_Crypt_SkeletonRisingCinematic_a966e44d-6d7c-48d1-5d3b-6469ae00720b,_Player,0)
AND
QRY_StartDialogCustom_Fixed(CHA_Crypt_SkeletonRisingCinematic_a966e44d-6d7c-48d1-5d3b-6469ae00720b,S_CHA_FL0_DeadSkeleton_Ranger_01_1535feb9-7ff9-4132-be09-191ba3f8c2e1,S_CHA_FL0_DeadSkeleton_Ranger_02_462f0982-35c4-4a34-a3bf-399f37e686ee,S_CHA_FL0_DeadSkeleton_Ranger_03_cb4c2c8f-b6db-4c53-b7e3-395aef311a39,S_CHA_FL0_DeadSkeleton_Melee_01_ebf854f1-7971-4f81-a2b7-e4b79b550b85,S_CHA_FL0_DeadSkeleton_Melee_02_7af3fa6c-7f7a-4920-acaf-f091e7c62373,_Player,0,0,0,0)
THEN
DB_CHA_CinematicLaunched(1);
TimerLaunch("CHA_1Candle",400);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CHA_Crypt_SkeletonRisingCinematic_a966e44d-6d7c-48d1-5d3b-6469ae00720b, _DialogID)
THEN
PROC_DialogAddSpeakingActor(_DialogID, S_CHA_Door_SlidingWall_DungeonAbbey_A_001_cb0c8869-6e84-4736-9810-ef997b4dad54);

IF
TimerFinished("CHA_RisingCinematic")
AND
NOT DB_CHA_CinematicLaunched(1)
THEN
PROC_CHA_TurnAllLightOff();
PROC_CHA_ResurrectAllSkeletons();
PROC_SetRelationToPlayers(ACT1_CHA_CryptGuardian_6ce9503d-92cf-3e01-aa83-6065f22e6747, 0);
TimerLaunch("CHA_VBAfterCinematic",1000);

IF
TimerFinished("CHA_1Candle")
THEN
SetEntityEvent(S_CHA_FL0_Candles_F_004_59380f30-d38b-4d02-9527-c93717ab30c2,"turnOff", 1);
TimerLaunch("CHA_2Candle",600);

IF
TimerFinished("CHA_2Candle")
THEN
SetEntityEvent(S_CHA_FL0_Candles_E_000_a35bef52-af23-447e-82d2-277fd1123559,"turnOff, 1");
TimerLaunch("CHA_3Candle",750);

IF
TimerFinished("CHA_3Candle")
THEN
SetEntityEvent(S_CHA_FL0_Candles_E_004_81a8b173-76ac-410c-9947-a61a06191725,"turnOff", 1);
PROC_CHA_TurnAllLightOff();
TimerLaunch("CHA_UndeadRise",1370);

IF
TimerFinished("CHA_UndeadRise")
THEN
TimerLaunch("CHA_RisingCinematicOver",9000);
PROC_CHA_ResurrectAllSkeletons();

// Case for dialog ending too soon/players skipping it
IF
DialogEnded((DIALOGRESOURCE)CHA_Crypt_SkeletonRisingCinematic_a966e44d-6d7c-48d1-5d3b-6469ae00720b, _)
THEN
PROC_CHA_ResurrectAllSkeletons();

PROC
PROC_CHA_ResurrectAllSkeletons()
AND
NOT DB_CHA_Crypt_SkeletonsResurrected(1)
AND
DB_CHA_UndeadGuardian(_Skeleton)
THEN
Resurrect(_Skeleton, STAT_KO_01_End_37fe9557-0310-4273-9e28-03c1613e4101,1);

PROC
PROC_CHA_ResurrectAllSkeletons()
THEN
DB_CHA_Crypt_SkeletonsResurrected(1);
PROC_SetRelationToPlayers((FACTION)ACT1_CHA_CryptGuardian_6ce9503d-92cf-3e01-aa83-6065f22e6747, 0);

IF
Resurrected(_Skeleton)
AND
DB_CHA_UndeadGuardian(_Skeleton)
AND
DB_CanBeResurrected(_Skeleton)
AND
DB_CHA_TakerOfArtefact(_Player)
AND
NOT QRY_CharacterIsHidden(_Player)
THEN
EnterCombat(_Skeleton, _Player);

IF
Resurrected(_Skeleton)
AND
DB_CHA_UndeadGuardian(_Skeleton)
THEN
NOT DB_CanBeResurrected(_Skeleton);
DB_GLO_DefeatCounter(_Skeleton,"CHA_UndeadGuardians");

IF
TimerFinished("CHA_RisingCinematicOver")
THEN
PROC_SetRelationToPlayers(ACT1_CHA_CryptGuardian_6ce9503d-92cf-3e01-aa83-6065f22e6747, 0);

IF
DialogEnded(CHA_Crypt_SkeletonRisingCinematic_a966e44d-6d7c-48d1-5d3b-6469ae00720b,_ID)
THEN
TimerLaunch("CHA_VBAfterCinematic",1000);

IF
DialogEnded(CHA_Crypt_SkeletonRisingCinematic_a966e44d-6d7c-48d1-5d3b-6469ae00720b,_ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
PROC_EnterCombat(S_CHA_FL0_DeadSkeleton_Melee_01_ebf854f1-7971-4f81-a2b7-e4b79b550b85, _Player);

IF
TimerFinished("CHA_VBAfterCinematic")
AND
DB_CHA_TakerOfArtefact(_Player)
THEN
StartVoiceBark(CHA_TakingTheArtefact_VB_506e3c7a-a4b0-8e31-8676-f9b40210927d,_Player);
PROC_TriggerRegisterForPlayers(S_CHA_GuardianFight_e1199dde-3731-4247-bd87-3ffb1f4053f6);
PROC_TriggerUnregisterForPlayers(S_CHA_FL0_RisingCinematicInclusion_f929b9ee-3d22-443e-91ab-8385255dbe8d);
//END_REGION

//REGION Reflection dialog after undead guardian
IF
DB_Is_InCombat(_Undead, _CombatID)
AND
DB_CHA_UndeadGuardian((CHARACTER)_Undead)
THEN
DB_CHA_UndeadCombat(_CombatID);
SetFlag(CHA_FL0_State_CombatWithSkeletonHappened_5ae19cbb-1759-41f7-bc83-5c17bea3e3f6,NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(CHA_FL0_State_AllSkeletonDead_a2c88791-9ff6-4bd8-8945-78e819389a3e, _, _)
THEN
PROC_CHA_AfterHeistReflectionDialog();

IF
LeftCombat(_Player,_CombatID)
AND
DB_CHA_TakerOfArtefact((CHARACTER)_Player)
AND
DB_CHA_UndeadCombat(_CombatID)
AND
NOT DB_InRegion(_Player,S_CHA_GuardianFight_e1199dde-3731-4247-bd87-3ffb1f4053f6)
THEN
PROC_CHA_AfterHeistReflectionDialog();

IF
CombatEnded(_CombatID)
AND
DB_CHA_UndeadCombat(_CombatID)
THEN
NOT DB_CHA_UndeadCombat(_CombatID);

IF
DB_CHA_TakerOfArtefact(_Player)
AND
NOT DB_InRegion(_Player,S_CHA_ExitGuardianFight_db2a38d6-bf88-4b28-9ecc-2901260bc8c2)
AND
NOT DB_Is_InCombat(_Player,_)
THEN
PROC_CHA_AfterHeistReflectionDialog();

PROC
PROC_CHA_AfterHeistReflectionDialog()
AND
DB_CHA_TakerOfArtefact(_Player)
AND
QRY_OnlyOnce("CHA_GraveRobbingRD")
THEN
NOT DB_CHA_TakerOfArtefact(_Player);
PROC_TriggerUnregisterForPlayers(S_CHA_ExitGuardianFight_db2a38d6-bf88-4b28-9ecc-2901260bc8c2);
PROC_TriggerUnregisterForPlayers(S_CHA_GuardianFight_e1199dde-3731-4247-bd87-3ffb1f4053f6);
StartVoiceBark((VOICEBARKRESOURCE)CHA_Crypt_VB_SuccessfulGraverobbing_fa3edd9b-e7ae-ea00-65dd-62be7c1c36e7, _Player);
//END_REGION

//REGION Track how many times Shadowheart comments about Selune
IF
AutomatedDialogRequestFailed(_Dialog, _)
AND
DB_Players(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_CHA_ShadowheartCommentADs(_Dialog)
THEN
DB_CHA_Shadowheart_DontUpdateCounter(1);

IF
AutomatedDialogEnded(_Dialog, _)
AND
DB_Players(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_CHA_ShadowheartCommentADs(_Dialog)
AND
GUIDToString(_Dialog, _Str)
THEN
PROC_CHA_ShadowheartComments();

IF
VoiceBarkFailed(_Bark)
AND
DB_Players(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_CHA_ShadowheartCommentVBs(_Bark)
THEN
DB_CHA_Shadowheart_DontUpdateCounter(1);

IF
VoiceBarkEnded(_Bark, _)
AND
DB_Players(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_CHA_ShadowheartCommentVBs(_Bark)
THEN
PROC_CHA_ShadowheartComments();


PROC
PROC_CHA_ShadowheartComments()
AND
NOT DB_CHA_Shadowheart_DontUpdateCounter(1)
AND
DB_CHA_ShadowheartCommentCounter(_OldCounter)
AND
IntegerSum(_OldCounter, 1, _Counter)
THEN
NOT DB_CHA_ShadowheartCommentCounter(_OldCounter);
DB_CHA_ShadowheartCommentCounter(_Counter);

PROC
PROC_CHA_ShadowheartComments()
AND
NOT DB_CHA_Shadowheart_DontUpdateCounter(1)
AND
DB_CHA_ShadowheartCommentCounter(_Counter)
AND
DB_CHA_ShadowheartMaxComments(_Counter)
THEN
DebugText(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "Max comments reached, stop commenting");
ClearFlag((FLAG)CHA_Shadowheart_SeluneComment_fdedef69-720c-5b93-06c6-d7547d4cfbd3, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_CHA_ShadowheartComments()
AND
DB_CHA_Shadowheart_DontUpdateCounter(1)
THEN
DebugText(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "AD or VB failed");
NOT DB_CHA_Shadowheart_DontUpdateCounter(1);
//END_REGION

//REGION Ladder leading to the outside
IF
DualEntityEvent(_, S_CHA_FL0_LadderLever_752e35f8-c47b-428f-b3d6-30206bf22d1e, "CHA_FL0_LadderLeverUsed")
THEN
Unlock(S_CHA_OUTSIDE_CryptHatch_76d53fd7-dc26-4dde-822a-485e0f19937a);

IF
Unlocked(S_CHA_OUTSIDE_CryptHatch_76d53fd7-dc26-4dde-822a-485e0f19937a, _, _)
THEN
PROC_CHA_DropLadder();

IF
Unlocked(S_CHA_OUTSIDE_CryptHatch_76d53fd7-dc26-4dde-822a-485e0f19937a, _, _)
THEN
PROC_CHA_DropLadder();

PROC
PROC_CHA_DropLadder()
AND
QRY_OnlyOnce("CHA_DropLadder")
THEN
PlaySound(S_CHA_FL0_LadderToOutside_a7c7ffa0-a495-42c5-bcd1-fc1767d2affd, "SE_CHA_SecretExit");
ItemMoveTo(S_CHA_FL0_LadderToOutside_a7c7ffa0-a495-42c5-bcd1-fc1767d2affd, S_CHA_FL0_LadderPosition_fc9913d9-8a00-4f0e-b5ee-442c5df327ce, 5.0, 1.0, 0, "CHA_LadderDropped", 0);

IF
EntityEvent(_Item, "CHA_LadderDropped")
THEN
SetCanInteract((ITEM)_Item, 1);

//END_REGION

//REGION Party banters
PROC
PROC_LongRest()
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
PROC_CHA_TrySetChapelPartyBanters();

IF
QuestUpdateUnlocked(_, "CHA_Chapel", _)
THEN
PROC_CHA_TrySetChapelPartyBanters();

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("CHA_ChapelInsideBandits")
THEN
PROC_CHA_TrySetChapelPartyBanters();

PROC
PROC_CHA_TrySetChapelPartyBanters()
AND
NOT DB_WorldGossipTrigger(S_PartyBanterTrigger_CRA_ChapelCleared_65a9e678-973f-4eca-8232-440b20d94cc1,_,_)
AND
DB_CHA_EnteredAlcove(1)
AND
DB_GlobalFlag(CHA_FL1_State_BanditsDead_d92afbc6-b7ac-431b-b440-1c5fa30ea688)
AND
QRY_CHA_OutsideBanditsDefeated()
THEN
PROC_RegisterWorldGossipTrigger(S_PartyBanterTrigger_CRA_ChapelCleared_65a9e678-973f-4eca-8232-440b20d94cc1);

QRY
QRY_CHA_OutsideBanditsDefeated()
AND
DB_GlobalFlag((FLAG)CHA_Outside_Event_BanditsPermaDefeated_c61f7816-570e-4012-a10a-3a6d63c77608)
THEN
DB_NOOP(1);

QRY
QRY_CHA_OutsideBanditsDefeated()
AND
DB_GlobalFlag((FLAG)CHA_OUTSIDE_Event_BanditScared_afe707eb-108a-d6c0-3c32-69c3eb12a589)
THEN
DB_NOOP(1);
//END_REGION

//REGION Candles puzzle
PROC
PROC_BlockLockpickItem(_Player, S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10)
THEN
QuestUpdate(_Player, "CHA_Chapel", "WeirdDoor");
PROC_TryStartAD(CHA_Crypt_AD_UpDownDoorInvestigation_5339fc90-bc38-c0ef-52dd-d4779105e3b6,_Player);
DB_CustomLockpickItemResponse(_Player, S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10, 0);

// Avoids playing the mechanical click twice when the door is unlocked for the first time
IF
StatusApplied(_Candle, "BURNING", _, _)
AND
DB_CHA_CandlesPuzzle(_Candle)
AND
QRY_CHA_BothCandlesBurning()
AND
DB_OnlyOnce("CHA_StairDoor_Unlocked")
THEN
PROC_TryStartAD(GLO_AD_MechanicalClick_fc8d3dc5-b947-6354-3aa9-d1f02fd51af4,CHA_FL1_Stairs_Door_4877f5d8-67b8-419f-a731-f0566821e045);

IF
StatusApplied(_Candle, "BURNING", _Char, _)
AND
DB_CHA_CandlesPuzzle(_Candle)
AND
IsDestroyed(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10, 0)
AND
QRY_CHA_BothCandlesBurning()
THEN
PROC_ItemUnlockAndOpen(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10);
PlaySound(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10,"SE_CHA_Door_Unlock");
PROC_CHA_FL1_WeirdDoorUnlocked();

IF
StatusRemoved(_Candle, "BURNING", _, _)
AND
DB_CHA_CandlesPuzzle(_Candle)
AND
IsClosed(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10, 0)
THEN
Close(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10);

IF
StatusRemoved(_Candle, "BURNING", _, _)
AND
DB_CHA_CandlesPuzzle(_Candle)
THEN
Lock(S_CHA_FL1_Stairs_Door_a1e0afa3-7a19-4607-8113-9b0b4dbe3c10, "CHA_BetweenUpAndDown");

QRY
QRY_CHA_BothCandlesBurning()
AND
NOT QRY_CHA_AnyCandleNotBurning()
THEN
DB_NOOP(1);

QRY
QRY_CHA_AnyCandleNotBurning()
AND
DB_CHA_CandlesPuzzle(_Candle)
AND
HasActiveStatus(_Candle, "BURNING", 0)
THEN
DB_NOOP(1);
//END_REGION

//REGION VB reactions
IF
VoiceBarkStarted(CHA_FL0_VB_SideChamber_99cf32ba-8377-4bc7-32e5-8cce52550559, _)
THEN
PROC_PlayPerceptionRevealEffect(S_CHA_Crypt_BookOfRestoredGods_a480a240-b8ea-4e6a-b4b9-a8edc8fd4a3d,"CHA_Crypt_HighlightBookOfRestoredGods");

// Finding coins inside the crypt
IF
AddedTo(_Coins, _Player, _)
AND
DB_CHA_Crypt_Coins((ITEM)_Coins)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("CHA_FoundCoins")
THEN
PROC_TryStartAD(CHA_Crypt_PAD_FoundCoins_d43aec7a-89eb-3e91-a232-de65d28489c7, _Player);
//END_REGION

//REGION Jergal
// Block use if a player tries to open the tomb before fighting the skeletons
PROC
PROC_BlockUseOfItem(_Player, S_CHA_TrappedTomb_Lid_Artefact_0a4e73ea-a217-4a23-8c4e-1844e93a5ad7)
AND
NOT DB_CHA_Crypt_JergalLeftTomb(1)
AND
NOT DB_GlobalFlag(CHA_FL0_State_AllSkeletonDead_a2c88791-9ff6-4bd8-8945-78e819389a3e)
THEN
DB_CustomUseItemResponse(_Player, S_CHA_TrappedTomb_Lid_Artefact_0a4e73ea-a217-4a23-8c4e-1844e93a5ad7, 0);
PROC_TryStartAD(CHA_Crypt_AD_JergalInsideTomb_915d4f73-0f1a-3d21-f2a3-25c2d23944e5, S_CHA_TrappedTomb_Lid_Artefact_0a4e73ea-a217-4a23-8c4e-1844e93a5ad7);

PROC
PROC_BlockUseOfItem(_Player, S_CHA_TrappedTomb_Lid_Artefact_0a4e73ea-a217-4a23-8c4e-1844e93a5ad7)
AND
NOT DB_CHA_Crypt_JergalLeftTomb(1)
AND
DB_GlobalFlag(CHA_FL0_State_AllSkeletonDead_a2c88791-9ff6-4bd8-8945-78e819389a3e)
AND
NOT DB_GlobalFlag(GLO_Jergal_State_OutOfTomb_55294438-06e2-467c-9873-757f74d20645)
AND
QRY_CHA_Crypt_StartJergalDialog(_Player)
THEN
DB_CHA_Crypt_JergalLeftTomb(1);
DB_CustomUseItemResponse(_Player, S_CHA_TrappedTomb_Lid_Artefact_0a4e73ea-a217-4a23-8c4e-1844e93a5ad7, 0);

IF
DialogStarted((DIALOGRESOURCE)CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5, _)
THEN
SetFlag((FLAG)CHA_Jergal_Event_InteractedWithTomb_703d93aa-823b-4c6f-a677-e5271d97e38d, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet((FLAG)CHA_Jergal_HasMet_70b87ded-1ef6-a42e-dda5-2e0659fc5cec, _, _)
THEN
SetFlag((FLAG)CHA_Jergal_HasMet_AtChapel_58201daf-b32c-4fc5-a8d4-74e9eeb9cf2c, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_DialogShouldDropMutingStatussesForSpeaker((DIALOGRESOURCE)CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5, (GUIDSTRING)_Speaker)
AND
NOT DB_Players((CHARACTER)_Speaker)
THEN
DB_NOOP(1);


QRY
QRY_DialogShouldDropMutingStatussesForSpeaker((DIALOGRESOURCE)CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5, (GUIDSTRING)_Speaker)
AND
DB_Players((CHARACTER)_Speaker)
AND
HasActiveStatus(_Speaker, "SILENCED", 0)
THEN
DB_NOOP(1);

QRY
QRY_CHA_Crypt_StartJergalDialog((GUIDSTRING)_Player)
AND
QRY_StartDialog_Fixed(CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _Player)
THEN
DB_NOOP(1);

QRY
QRY_CHA_Crypt_StartJergalDialog(_Player)
AND
DB_QRYRTN_StartDialog_FailReason("ShapeshiftOverride")
THEN
DB_NOOP(1);

QRY
QRY_CHA_Crypt_StartJergalDialog(_Player)
AND
DB_DialogStart_WaitingForDroppedMutingStatus(CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5, _, _, _, _, _, _, _)
THEN
DB_NOOP(1);

IF
DialogStarted(CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5, _)
THEN
SetFlag(CHA_Crypt_State_SpokeToJergal_6bae2cfe-cb72-45c6-b828-823bcfa8546a, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(CHA_Crypt_Event_JergalAppears_08a2a27a-bef4-2772-ab8e-707296ddbae1, _, _)
THEN
TeleportTo(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, S_CHA_Crypt_JergalAppearPos_a98789a2-be08-41f0-9215-e3ed38076a32);

IF
DialogEnded(CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5, _)
THEN
PROC_TriggerUnregisterForPlayers(S_CHA_Crypt_JergalRiseTrigger_a4efa36c-88b2-4378-bc30-9faa3c2b9510);
PROC_AddCharactersInTriggerToDialog_Clear((DIALOGRESOURCE)CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5, (TRIGGER)S_CHA_Crypt_JergalRiseTrigger_a4efa36c-88b2-4378-bc30-9faa3c2b9510);

// Players leave the area and Jergal is still inside the Crypt
IF
LeftTrigger(_Char, S_CHA_Crypt_SUB_002_fec6419e-a387-4799-bb28-ba008f2d0e96)
AND
DB_Players(_Char)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_CHA_Crypt_SUB_002_fec6419e-a387-4799-bb28-ba008f2d0e96)
AND
DB_GlobalFlag(GLO_Jergal_State_OutOfTomb_55294438-06e2-467c-9873-757f74d20645)
THEN
ClearFlag(CHA_Jergal_Event_AttemptedAttack_c2fc2844-dfe7-4eb2-6ab6-301eea35fe4e, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
PROC_GLO_Jergal_MoveToCamp();

IF
FlagSet(GLO_Jergal_State_OutOfTomb_55294438-06e2-467c-9873-757f74d20645, _, _)
THEN
ClearFlag(CHA_Crypt_State_SecretRoomOpenAndJergalInSarcophagus_0ef70c0c-2da5-4ea1-b7a5-60dd2e0fe65c, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5);

IF
DialogEnded(CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5, _)
THEN
// Need a small delay in case the dialog ends because player chooses to attack him using the attack button.
RealtimeObjectTimerLaunch(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "CHA_TryChangeJergalsDialog", 10);

IF
ObjectTimerFinished(_, "CHA_TryChangeJergalsDialog")
AND
GetFlag(CHA_Jergal_Event_AttemptedAttack_c2fc2844-dfe7-4eb2-6ab6-301eea35fe4e, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 0)
THEN
PROC_GLO_Jergal_SetDialog((DIALOGRESOURCE)CHA_Crypt_JergalWandering_e6d54be6-e5db-b233-88e1-7d51675fc7b6);

// Addresses if he is not visible because he is still coming out of the sarcophagus.
QRY
QRY_DialogAttackRequested_CustomResponse(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _)
THEN
SetVisible(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 1);
SetDetached(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 0);

// If players try to take hostile actions while he is roaming the chapel, clear the flag after 12 seconds (2 turns)
QRY
QRY_DialogAttackRequested_CustomResponse(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _)
AND
DB_DialogNPCs(_DialogID, (CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _)
AND
DB_DialogName(CHA_Crypt_JergalWandering_e6d54be6-e5db-b233-88e1-7d51675fc7b6, _DialogID)
THEN
PROC_GLO_Jergal_RemoveAttackedFlagTimer(12000);
//END_REGION

//REGION Crime reactions
// Bandit will react by attacking the player to crimes.
QRY
QRY_CrimeGetCustomWarning((CHARACTER)_Bandit, _, _, _CrimeID)
AND
DB_SceneManager(_Bandit, "CHA_OutsideBandit")
THEN
DB_CrimeWarning_CustomDialog(_Bandit, _CrimeID, (DIALOGRESOURCE)NGB_Attack_80d78319-8d61-53c6-053c-c40b8657892f);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
